{"version":3,"sources":["node_modules/browserify/node_modules/browser-pack/_prelude.js","system/main.js","server/mithril.bindings.node.js","client/js/mithril.animate.js","server/miso.permissions.js","system/auth.js","mvc/user.js","mvc/home.js","mvc/doc.js","mvc/flickr.js","mvc/hello.js","mvc/login.js","mvc/todo.js","client/js/miso.util.js","system/adaptor/flatfiledb/api.client.js","modules/adaptor/authentication/api.client.js","client/js/mithril.smoothscroll.js","client/miso.documentation.js","modules/adaptor/flickr/api.client.js","node_modules/mithril/mithril.js","node_modules/mithril.sugartags/mithril.sugartags.js","node_modules/validator.modelbinder/index.js","node_modules/validator/validator.js"],"names":["m","require","sugartags","bindings","animate","restrictions","auth","restrict","route","actionName","authenticate","oldController","controller","user","name","roles","isLoggedIn","console","log","restrictObj","app","apply","this","arguments","home","doc","flickr","hello","login","todo","window","mode","document","getElementById","/users/new","/","index","/doc/:doc_id","edit","/docs","/flickrs","/hello/:hello_id","/login","/todos","/user/:user_id","/users","mithrilBindings","p","value","prevValue","self","subs","delay","notify","i","length","func","context","prop","tmpPrev","push","val","subscribe","startComputation","endComputation","e","element","attrs","children","removeable","addBinding","unwrap","onchange","withAttr","checked","style","display","onclick","tmp","tVal","isFunc","vals","slice","onmouseover","onmouseout","events","createBinding","eve","toLowerCase","set","trigger","args","Array","prototype","call","argList","module","exports","define","amd","mithrilAnimate","prefixes","transitionProps","transformProps","defaultDuration","err","msg","error","cap","str","charAt","toUpperCase","substr","div","createElement","vp","pf","supportsTransitions","b","body","documentElement","s","getTimeinMS","result","indexOf","split","Number","Math","round","setStyleProps","obj","props","hasOwnProperty","setTransitionProps","tmp2","found","TransitionTimingFunction","TransitionDuration","TransitionProperty","normaliseTransformProps","normal","aniName","JSON","stringify","join","animations","canTrans","animateProperties","el","cb","time","$","fn","setTimeout","options","ani","target","addAnimation","duration","bindAnimation","addKFAnimation","arg","init","kf","aniId","hasAni","id","setAttribute","textContent","head","appendChild","isInitialised","animateImmediately","animateKF","undefined","endAni","removeEventListener","requestAnimationFrame","addEventListener","triggerKF","oldConfig","config","isInit","basicBindings","degBindings","isNaN","skew","miso","hasRole","userRoles","each","userRole","role","permissions","pass","deny","allow","api","secret","req","res","next","sess","session","authenticated","originalUrl","requestType","redirect","validate","lapi","find","type","then","data","editView","ctrl","DIV","class","H2","header","LABEL","INPUT","isValid","showErrors","email","password","BUTTON","save","remove","vm","userList","users","list","Object","keys","map","key","models","view","c","u","UL","LI","A","href","model","_id","bind","isRequired","isEmail","params","userId","getParam","query","confirm","smoothScroll","intro","text","demoImgSrc","replay","tmpSrc","o","IMG","src","SPAN","P","PRE","CODE","docs","niceName","lastIndexOf","SCRIPT","data-manual","doc_id","LINK","rel","H1","ARTICLE","trust","pics","flickrData","photos","tags","tagmode","items","item","media","who","ldb","url","username","preventDefault","FORM","onsubmit","placeholder","db","done","background","initialValue","addTodo","input","newTodo","archive","response","left","count","STYLE","isServer","toString","readyBinder","ready","def","param","getModelData","requestObj","method","rootNode","className","myDeferred","deferred","request","resolve","redraw","promise","root","navigator","test","userAgent","easeInOutSine","t","d","cos","PI","isInitialized","startTime","startPos","scrollTop","endPos","exec","getBoundingClientRect","top","hash","maxScroll","scrollHeight","innerHeight","scrollEndValue","scrollFunc","timestamp","elapsed","progress","history","pushState","location","Creating-a-todo-app.md","Getting-started.md","Goals.md","Home.md","How-miso-works.md","Patterns.md","initialize","$document","$location","$cancelAnimationFrame","cancelAnimationFrame","clearTimeout","$requestAnimationFrame","match","hasAttrs","OBJECT","classAttrName","cell","tag","classes","STRING","Error","parser","pair","attrParser","ARRAY","attrName","build","parentElement","parentTag","parentCache","parentIndex","cached","shouldReattach","editable","namespace","configs","subtree","cachedType","dataType","nodes","offset","end","clear","constructor","len","concat","intact","subArrayCount","DELETION","INSERTION","MOVE","existing","unkeyed","shouldMaintainIdentities","action","filter","x","keysDiffer","cachedCell","dataCell","from","childNodes","actions","change","changes","sort","sortChanges","newCached","splice","dummy","insertBefore","child","cacheCount","$trusted","node","parentNode","dataAttrKeys","hasKeys","configContext","onunload","FUNCTION","isNew","xmlns","is","createElementNS","setAttributes","contenteditable","callback","injectHTML","createTextNode","nodeName","voidElements","valueOf","activeElement","innerHTML","nodeType","nodeValue","a","dataAttrs","cachedAttrs","dataAttr","cachedAttr","autoredraw","rule","setAttributeNS","message","removeChild","unload","nextSibling","isElement","insertAdjacentHTML","object","event","strategy","endFirstComputation","getCellCacheKey","nodeCache","gettersetter","store","toJSON","forceRedraw","roots","controllers","render","modules","blank","computePostRedrawHook","lastRedrawId","lastRedrawCallTime","Date","normalizeRoute","modes","routeByValue","router","path","routeParams","queryStart","parseQueryString","matcher","RegExp","replace","values","decodeURIComponent","routeUnobtrusive","ctrlKey","metaKey","which","returnValue","currentTarget","search","setScroll","scrollTo","buildQueryString","prefix","valueType","encodeURIComponent","pairs","reset","cacheKey","cellCache","propify","reject","Deferred","successCallback","failureCallback","finish","state","REJECTED","RESOLVED","promiseValue","thennable","notThennableCallback","onerror","fire","REJECTING","RESOLVING","TypeError","identity","ajax","xhr","XMLHttpRequest","open","onreadystatechange","readyState","status","onload","serialize","setRequestHeader","deserialize","parse","maybeXhr","FormData","send","callbackKey","getTime","random","script","resp","responseText","bindData","xhrOptions","querystring","parameterizeUrl","tokens","html","documentNode","replaceChild","forceRecreation","isDocumentRoot","String","topModule","FRAME_BUDGET","isPrevented","currentModule","force","pendingRequests","max","withAttrCallback","getAttribute","currentRoute","pathname","defaultRoute","source","listener","oldRoute","queryIndex","currentPath","shouldReplaceHistoryEntry","title","sync","synchronizer","pos","resolved","results","outstanding","isJSONP","extract","unwrapSuccess","unwrapError","deps","mock","factory","mithrilSugartags","scope","sugarTags","l1","l2","getClassList","makeSugarTag","tagList","lowerTagCache","lowerTag","lower","validator","vObj","hasInvalidField","isNotEmpty","getValue","validations","validation","definition","merge","defaults","version","creditCard","isbn10Maybe","isbn13Maybe","ipv4Maybe","ipv6","uuid","3","4","5","all","alpha","alphanumeric","numeric","int","float","hexadecimal","hexcolor","ascii","multibyte","fullWidth","halfWidth","surrogatePair","base64","phones","zh-CN","en-ZA","en-AU","extend","toDate","date","toFloat","parseFloat","toInt","radix","parseInt","toBoolean","strict","equals","comparison","contains","elem","matches","pattern","modifiers","default_url_options","protocols","require_tld","require_protocol","allow_underscores","allow_trailing_dot","isURL","protocol","host","hostname","port","port_str","shift","isIP","isFQDN","host_whitelist","host_blacklist","parts","default_fqdn_options","substring","tld","pop","part","isAlpha","isAlphanumeric","isNumeric","isHexadecimal","isHexColor","isLowercase","isUppercase","isInt","isFloat","isDivisibleBy","num","isNull","isLength","min","surrogatePairs","isByteLength","isUUID","isDate","isAfter","original","isBefore","isIn","array","isCreditCard","sanitized","digit","tmpNum","shouldDouble","sum","isISBN","checksum","factor","isMobilePhone","locale","isJSON","isMultibyte","isAscii","isFullWidth","isHalfWidth","isVariableWidth","isSurrogatePair","isBase64","isMongoId","ltrim","chars","rtrim","trim","escape","stripLow","keep_new_lines","blacklist","whitelist","default_normalize_email_options","lowercase","normalizeEmail"],"mappings":"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","file":"bundle.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/* NOTE: This is a generated file, please do not modify it, your changes will be lost */\nvar m = require('mithril');\nvar sugartags = require('mithril.sugartags')(m);\nvar bindings = require('../server/mithril.bindings.node.js')(m);\nvar animate = require('../client/js/mithril.animate.js')(m);\nvar restrictions = require('../server/miso.permissions.js');\nvar auth = require('../system/auth.js');\nvar restrict = function(route, actionName){\n\tif(route.authenticate){\n\t\tvar oldController = route.controller, user = {\n\t\t\tname: 'you',\n\t\t\troles: ['admin']\n\t\t}, isLoggedIn = false;\n\t\troute.controller = function() {\n\t\t\tif(!isLoggedIn) {\n\t\t\t\tconsole.log('redirect to login');\n\t\t\t\treturn m.route('/login?url=' + m.route() );\n\t\t\t}\n\t\t\tconsole.log(restrictObj.app[actionName]);\n\t\t\tif(!restrictions(restrictObj.app[actionName], user)){\n\t\t\t\tconsole.log('ACCESS DENIED');\n\t\t\t}\n\t\t\tconsole.log('auth here...', actionName);\n\t\t\toldController.apply(this, arguments);\n\t\t};\n\t}\n\treturn route;\n};\nvar restrictObj = (undefined);\nvar user = require('../mvc/user.js');\nvar home = require('../mvc/home.js');\nvar doc = require('../mvc/doc.js');\n\nvar flickr = require('../mvc/flickr.js');\nvar hello = require('../mvc/hello.js');\nvar login = require('../mvc/login.js');\nvar todo = require('../mvc/todo.js');\n\n\nif(typeof window !== 'undefined') {\n\twindow.m = m;\n}\n\t\nm.route.mode = 'pathname';\nm.route(document.getElementById('misoAttachmentNode'), '/', {\n'/users/new': restrict(user.new, 'user.new'),\n'/': restrict(home.index, 'home.index'),\n'/doc/:doc_id': restrict(doc.edit, 'doc.edit'),\n'/docs': restrict(doc.index, 'doc.index'),\n'/flickrs': restrict(flickr.index, 'flickr.index'),\n'/hello/:hello_id': restrict(hello.edit, 'hello.edit'),\n'/login': restrict(login.index, 'login.index'),\n'/todos': restrict(todo.index, 'todo.index'),\n'/user/:user_id': restrict(user.edit, 'user.edit'),\n'/users': restrict(user.index, 'user.index')\n});","//\tMithril bindings.\n//\tCopyright (C) 2014 jsguy (Mikkel Bergmann)\n//\tMIT licensed\n(function(){\nvar mithrilBindings = function(m){\n\tm.bindings = m.bindings || {};\n\n\t//\tPub/Sub based extended properties\n\tm.p = function(value) {\n\t\tvar self = this,\n\t\t\tsubs = [],\n\t\t\tprevValue,\n\t\t\tdelay = false,\n\t\t\t//  Send notifications to subscribers\n\t\t\tnotify = function (value, prevValue) {\n\t\t\t\tvar i;\n\t\t\t\tfor (i = 0; i < subs.length; i += 1) {\n\t\t\t\t\tsubs[i].func.apply(subs[i].context, [value, prevValue]);\n\t\t\t\t}\n\t\t\t},\n\t\t\tprop = function() {\n\t\t\t\tif (arguments.length) {\n\t\t\t\t\tvalue = arguments[0];\n\t\t\t\t\tif (prevValue !== value) {\n\t\t\t\t\t\tvar tmpPrev = prevValue;\n\t\t\t\t\t\tprevValue = value;\n\t\t\t\t\t\tnotify(value, tmpPrev);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn value;\n\t\t\t};\n\n\t\t//\tAllow push on arrays\n\t\tprop.push = function(val) {\n\t\t\tif(value.push && typeof value.length !== \"undefined\") {\n\t\t\t\tvalue.push(val);\n\t\t\t}\n\t\t\tprop(value);\n\t\t};\n\n\t\t//\tSubscribe for when the value changes\n\t\tprop.subscribe = function (func, context) {\n\t\t\tsubs.push({ func: func, context: context || self });\n\t\t\treturn prop;\n\t\t};\n\n\t\t//\tAllow property to not automatically render\n\t\tprop.delay = function(value) {\n\t\t\tdelay = !!value;\n\t\t\treturn prop;\n\t\t};\n\n\t\t//\tAutomatically update rendering when a value changes\n\t\t//\tAs mithril waits for a request animation frame, this should be ok.\n\t\t//\tYou can use .delay(true) to be able to manually handle updates\n\t\tprop.subscribe(function(val){\n\t\t\tif(!delay) {\n\t\t\t\tm.startComputation();\n\t\t\t\tm.endComputation();\n\t\t\t}\n\t\t\treturn prop;\n\t\t});\n\n\t\treturn prop;\n\t};\n\n\t//\tElement function that applies our extended bindings\n\t//\tNote: \n\t//\t\t. Some attributes can be removed when applied, eg: custom attributes\n\t//\t\n\tm.e = function(element, attrs, children) {\n\t\tfor (var name in attrs) {\n\t\t\tif (m.bindings[name]) {\n\t\t\t\tm.bindings[name].func.apply(attrs, [attrs[name]]);\n\t\t\t\tif(m.bindings[name].removeable) {\n\t\t\t\t\tdelete attrs[name];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn m(element, attrs, children);\n\t};\n\n\t//\tAdd bindings method\n\t//\tNon-standard attributes do not need to be rendered, eg: valueInput\n\t//\tso they are set as removable\n\tm.addBinding = function(name, func, removeable){\n\t\tm.bindings[name] = {\n\t\t\tfunc: func,\n\t\t\tremoveable: removeable\n\t\t};\n\t};\n\n\t//\tGet the underlying value of a property\n\tm.unwrap = function(prop) {\n\t\treturn (typeof prop == \"function\")? prop(): prop;\n\t};\n\n\t//\tBi-directional binding of value\n\tm.addBinding(\"value\", function(prop) {\n\t\tif (typeof prop == \"function\") {\n\t\t\tthis.value = prop();\n\t\t\tthis.onchange = m.withAttr(\"value\", prop);\n\t\t} else {\n\t\t\tthis.value = prop;\n\t\t}\n\t});\n\n\t//\tBi-directional binding of checked property\n\tm.addBinding(\"checked\", function(prop) {\n\t\tif (typeof prop == \"function\") {\n\t\t\tthis.checked = prop();\n\t\t\tthis.onchange = m.withAttr(\"checked\", prop);\n\t\t} else {\n\t\t\tthis.checked = prop;\n\t\t}\n\t});\n\n\t//\tHide node\n\tm.addBinding(\"hide\", function(prop){\n\t\tthis.style = {\n\t\t\tdisplay: m.unwrap(prop)? \"none\" : \"\"\n\t\t};\n\t}, true);\n\n\t//\tToggle value(s) on click\n\tm.addBinding('toggle', function(prop){\n\t\tthis.onclick = function(){\n\t\t\t//\tToggle allows an enum list to be toggled, eg: [prop, value2, value2]\n\t\t\tvar isFunc = typeof prop === 'function', tmp, i, vals = [], val, tVal;\n\n\t\t\t//\tToggle boolean\n\t\t\tif(isFunc) {\n\t\t\t\tvalue = prop();\n\t\t\t\tprop(!value);\n\t\t\t} else {\n\t\t\t\t//\tToggle enumeration\n\t\t\t\ttmp = prop[0];\n\t\t\t\tval = tmp();\n\t\t\t\tvals = prop.slice(1);\n\t\t\t\ttVal = vals[0];\n\n\t\t\t\tfor(i = 0; i < vals.length; i += 1) {\n\t\t\t\t\tif(val == vals[i]) {\n\t\t\t\t\t\tif(typeof vals[i+1] !== 'undefined') {\n\t\t\t\t\t\t\ttVal = vals[i+1];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttmp(tVal);\n\t\t\t}\n\t\t};\n\t}, true);\n\n\t//\tSet hover states, a'la jQuery pattern\n\tm.addBinding('hover', function(prop){\n\t\tthis.onmouseover = prop[0];\n\t\tif(prop[1]) {\n\t\t\tthis.onmouseout = prop[1];\n\t\t}\n\t}, true );\n\n\t//\tAdd value bindings for various event types \n\tvar events = [\"Input\", \"Keyup\", \"Keypress\"],\n\t\tcreateBinding = function(name, eve){\n\t\t\t//\tBi-directional binding of value\n\t\t\tm.addBinding(name, function(prop) {\n\t\t\t\tif (typeof prop == \"function\") {\n\t\t\t\t\tthis.value = prop();\n\t\t\t\t\tthis[eve] = m.withAttr(\"value\", prop);\n\t\t\t\t} else {\n\t\t\t\t\tthis.value = prop;\n\t\t\t\t}\n\t\t\t}, true);\n\t\t};\n\n\tfor(var i = 0; i < events.length; i += 1) {\n\t\tvar eve = events[i];\n\t\tcreateBinding(\"value\" + eve, \"on\" + eve.toLowerCase());\n\t}\n\n\n\t//\tSet a value on a property\n\tm.set = function(prop, value){\n\t\treturn function() {\n\t\t\tprop(value);\n\t\t};\n\t};\n\n\t/*\tReturns a function that can trigger a binding \n\t\tUsage: onclick: m.trigger('binding', prop)\n\t*/\n\tm.trigger = function(){\n\t\tvar args = Array.prototype.slice.call(arguments);\n\t\treturn function(){\n\t\t\tvar name = args[0],\n\t\t\t\targList = args.slice(1);\n\t\t\tif (m.bindings[name]) {\n\t\t\t\tm.bindings[name].func.apply(this, argList);\n\t\t\t}\n\t\t};\n\t};\n\n\treturn m.bindings;\n};\n\nif (typeof module != \"undefined\" && module !== null && module.exports) {\n\tmodule.exports = mithrilBindings;\n} else if (typeof define === \"function\" && define.amd) {\n\tdefine(function() {\n\t\treturn mithrilBindings;\n\t});\n} else {\n\tmithrilBindings(typeof window != \"undefined\"? window.m || {}: {});\n}\n\n}());","/*\n\tmithril.animate - Copyright 2014 jsguy\n\tMIT Licensed.\n*/\n(function(){\nvar mithrilAnimate = function (m) {\n\t//\tKnown prefiex\n\tvar prefixes = ['Moz', 'Webkit', 'Khtml', 'O', 'ms'],\n\ttransitionProps = ['TransitionProperty', 'TransitionTimingFunction', 'TransitionDelay', 'TransitionDuration', 'TransitionEnd'],\n\ttransformProps = ['rotate', 'rotatex', 'rotatey', 'scale', 'skew', 'translate', 'translatex', 'translatey', 'matrix'],\n\n\tdefaultDuration = 400,\n\n\terr = function(msg){\n\t\t(typeof window != \"undefined\") && window.console && console.error && console.error(msg);\n\t},\n\t\n\t//\tCapitalise\t\t\n\tcap = function(str){\n\t\treturn str.charAt(0).toUpperCase() + str.substr(1);\n\t},\n\n\t//\tFor checking what vendor prefixes are native\n\tdiv = document.createElement('div'),\n\n\t//\tvendor prefix, ie: transitionDuration becomes MozTransitionDuration\n\tvp = function (prop) {\n\t\tvar pf;\n\t\t//\tHandle unprefixed\n\t\tif (prop in div.style) {\n\t\t\treturn prop;\n\t\t}\n\n\t\t//\tHandle keyframes\n\t\tif(prop == \"@keyframes\") {\n\t\t\tfor (var i = 0; i < prefixes.length; i += 1) {\n\t\t\t\t//\tTesting using transition\n\t\t\t\tpf = prefixes[i] + \"Transition\";\n\t\t\t\tif (pf in div.style) {\n\t\t\t\t\treturn \"@-\" + prefixes[i].toLowerCase() + \"-keyframes\";\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn prop;\n\t\t}\n\n\t\tfor (var i = 0; i < prefixes.length; i += 1) {\n\t\t\tpf = prefixes[i] + cap(prop);\n\t\t\tif (pf in div.style) {\n\t\t\t\treturn pf;\n\t\t\t}\n\t\t}\n\t\t//\tCan't find it - return original property.\n\t\treturn prop;\n\t},\n\n\t//\tSee if we can use native transitions\n\tsupportsTransitions = function() {\n\t\tvar b = document.body || document.documentElement,\n\t\t\ts = b.style,\n\t\t\tp = 'transition';\n\n\t\tif (typeof s[p] == 'string') { return true; }\n\n\t\t// Tests for vendor specific prop\n\t\tp = p.charAt(0).toUpperCase() + p.substr(1);\n\n\t\tfor (var i=0; i<prefixes.length; i++) {\n\t\t\tif (typeof s[prefixes[i] + p] == 'string') { return true; }\n\t\t}\n\n\t\treturn false;\n\t},\n\n\t//\tConverts CSS transition times to MS\n\tgetTimeinMS = function(str) {\n\t\tvar result = 0, tmp;\n\t\tstr += \"\";\n\t\tstr = str.toLowerCase();\n\t\tif(str.indexOf(\"ms\") !== -1) {\n\t\t\ttmp = str.split(\"ms\");\n\t\t\tresult = Number(tmp[0]);\n\t\t} else if(str.indexOf(\"s\") !== -1) {\n\t\t\t//\ts\n\t\t\ttmp = str.split(\"s\");\n\t\t\tresult = Number(tmp[0]) * 1000;\n\t\t} else {\n\t\t\tresult = Number(str);\n\t\t}\n\n\t\treturn Math.round(result);\n\t},\n\n\t//\tSet style properties\n\tsetStyleProps = function(obj, props){\n\t\tfor(var i in props) {if(props.hasOwnProperty(i)) {\n\t\t\tobj.style[vp(i)] = props[i];\n\t\t}}\n\t},\n\n\t//\tSet props for transitions and transforms with basic defaults\n\tsetTransitionProps = function(args){\n\t\tvar props = {\n\t\t\t\t//\tease, linear, ease-in, ease-out, ease-in-out, cubic-bezier(n,n,n,n) initial, inherit\n\t\t\t\tTransitionTimingFunction: \"ease\",\n\t\t\t\tTransitionDuration: defaultDuration + \"ms\",\n\t\t\t\tTransitionProperty: \"all\"\n\t\t\t},\n\t\t\tp, i, tmp, tmp2, found;\n\n\t\t//\tSet any allowed properties \n\t\tfor(p in args) { if(args.hasOwnProperty(p)) {\n\t\t\ttmp = 'Transition' + cap(p);\n\t\t\ttmp2 = p.toLowerCase();\n\t\t\tfound = false;\n\n\t\t\t//\tLook at transition props\n\t\t\tfor(i = 0; i < transitionProps.length; i += 1) {\n\t\t\t\tif(tmp == transitionProps[i]) {\n\t\t\t\t\tprops[transitionProps[i]] = args[p];\n\t\t\t\t\tfound = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//\tLook at transform props\n\t\t\tfor(i = 0; i < transformProps.length; i += 1) {\n\t\t\t\tif(tmp2 == transformProps[i]) {\n\t\t\t\t\tprops[vp(\"transform\")] = props[vp(\"transform\")] || \"\";\n\t\t\t\t\tprops[vp(\"transform\")] += \" \" +p + \"(\" + args[p] + \")\";\n\t\t\t\t\tfound = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(!found) {\n\t\t\t\tprops[p] = args[p];\n\t\t\t}\n\t\t}}\n\t\treturn props;\n\t},\n\n\t//\tFix animatiuon properties\n\t//\tNormalises transforms, eg: rotate, scale, etc...\n\tnormaliseTransformProps = function(args){\n\t\tvar props = {},\n\t\t\ttmpProp,\n\t\t\tp, i, found,\n\t\t\tnormal = function(props, p, value){\n\t\t\t\tvar tmp = p.toLowerCase(),\n\t\t\t\t\tfound = false, i;\n\n\t\t\t\t//\tLook at transform props\n\t\t\t\tfor(i = 0; i < transformProps.length; i += 1) {\n\t\t\t\t\tif(tmp == transformProps[i]) {\n\t\t\t\t\t\tprops[vp(\"transform\")] = props[vp(\"transform\")] || \"\";\n\t\t\t\t\t\tprops[vp(\"transform\")] += \" \" +p + \"(\" + value + \")\";\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif(!found) {\n\t\t\t\t\tprops[p] = value;\n\t\t\t\t} else {\n\t\t\t\t\t//\tRemove transform property\n\t\t\t\t\tdelete props[p];\n\t\t\t\t}\n\t\t\t};\n\n\t\t//\tSet any allowed properties \n\t\tfor(p in args) { if(args.hasOwnProperty(p)) {\n\t\t\t//\tIf we have a percentage, we have a key frame\n\t\t\tif(p.indexOf(\"%\") !== -1) {\n\t\t\t\tfor(i in args[p]) { if(args[p].hasOwnProperty(i)) {\n\t\t\t\t\tnormal(args[p], i, args[p][i]);\n\t\t\t\t}}\n\t\t\t\tprops[p] = args[p];\n\t\t\t} else {\n\t\t\t\tnormal(props, p, args[p]);\n\t\t\t}\n\t\t}}\n\n\t\treturn props;\n\t},\n\n\n\t//\tIf an object is empty\n\tisEmpty = function(obj) {\n\t\tfor(var i in obj) {if(obj.hasOwnProperty(i)) {\n\t\t\treturn false;\n\t\t}}\n\t\treturn true; \n\t},\n\t//\tCreates a hashed name for the animation\n\t//\tUse to create a unique keyframe animation style rule\n\taniName = function(props){\n\t\treturn \"ani\" + JSON.stringify(props).split(/[{},%\":]/).join(\"\");\n\t},\n\tanimations = {},\n\n\t//\tSee if we can use transitions\n\tcanTrans = supportsTransitions();\n\n\t//\tIE10+ http://caniuse.com/#search=css-animations\n\tm.animateProperties = function(el, args, cb){\n\t\tel.style = el.style || {};\n\t\tvar props = setTransitionProps(args), time;\n\n\t\tif(typeof props.TransitionDuration !== 'undefined') {\n\t\t\tprops.TransitionDuration = getTimeinMS(props.TransitionDuration) + \"ms\";\n\t\t} else {\n\t\t\tprops.TransitionDuration = defaultDuration + \"ms\";\n\t\t}\n\n\t\ttime = getTimeinMS(props.TransitionDuration) || 0;\n\n\t\t//\tSee if we support transitions\n\t\tif(canTrans) {\n\t\t\tsetStyleProps(el, props);\n\t\t} else {\n\t\t\t//\tTry and fall back to jQuery\n\t\t\t//\tTODO: Switch to use velocity, it is better suited.\n\t\t\tif(typeof $ !== 'undefined' && $.fn && $.fn.animate) {\n\t\t\t\t$(el).animate(props, time);\n\t\t\t}\n\t\t}\n\n\t\tif(cb){\n\t\t\tsetTimeout(cb, time+1);\n\t\t}\n\t};\n\n\t//\tTrigger a transition animation\n\tm.trigger = function(name, value, options, cb){\n\t\toptions = options || {};\n\t\tvar ani = animations[name];\n\t\tif(!ani) {\n\t\t\treturn err(\"Animation \" + name + \" not found.\");\n\t\t}\n\n\t\treturn function(e){\n\t\t\tvar args = ani.fn(function(){\n\t\t\t\treturn typeof value == 'function'? value(): value;\n\t\t\t});\n\n\t\t\t//\tAllow override via options\n\t\t\tfor(i in options) if(options.hasOwnProperty(i)) {{\n\t\t\t\targs[i] = options[i];\n\t\t\t}}\n\n\t\t\tm.animateProperties(e.target, args, cb);\n\t\t};\n\t};\n\n\t//\tAdds an animation for bindings and so on.\n\tm.addAnimation = function(name, fn, options){\n\t\toptions = options || {};\n\n\t\tif(animations[name]) {\n\t\t\treturn err(\"Animation \" + name + \" already defined.\");\n\t\t} else if(typeof fn !== \"function\") {\n\t\t\treturn err(\"Animation \" + name + \" is being added as a transition based animation, and must use a function.\");\n\t\t}\n\n\t\toptions.duration = options.duration || defaultDuration;\n\n\t\tanimations[name] = {\n\t\t\toptions: options,\n\t\t\tfn: fn\n\t\t};\n\n\t\t//\tAdd a default binding for the name\n\t\tm.addBinding(name, function(prop){\n\t\t\tm.bindAnimation(name, this, fn, prop);\n\t\t}, true);\n\t};\n\n\tm.addKFAnimation = function(name, arg, options){\n\t\toptions = options || {};\n\n\t\tif(animations[name]) {\n\t\t\treturn err(\"Animation \" + name + \" already defined.\");\n\t\t}\n\n\t\tvar init = function(props) {\n\t\t\tvar aniId = aniName(props),\n\t\t\t\thasAni = document.getElementById(aniId),\n\t\t\t\tkf;\n\n\t\t\t//\tOnly insert once\n\t\t\tif(!hasAni) {\n\t\t\t\tanimations[name].id = aniId;\n\n\t\t\t\tprops = normaliseTransformProps(props);\n\t\t\t\t//  Create keyframes\n\t\t\t\tkf = vp(\"@keyframes\") + \" \" + aniId + \" \" + JSON.stringify(props)\n\t\t\t\t\t.split(\"\\\"\").join(\"\")\n\t\t\t\t\t.split(\"},\").join(\"}\\n\")\n\t\t\t\t\t.split(\",\").join(\";\")\n\t\t\t\t\t.split(\"%:\").join(\"% \");\n\n\t\t\t\tvar s = document.createElement('style');\n\t\t\t\ts.setAttribute('id', aniId);\n\t\t\t\ts.id = aniId;\n\t\t\t\ts.textContent = kf;\n\t\t\t\t//  Might not have head?\n\t\t\t\tdocument.head.appendChild(s);\n\t\t\t}\n\n\t\t\tanimations[name].isInitialised = true;\n\t\t\tanimations[name].options.animateImmediately = true;\n\t\t};\n\n\t\toptions.duration = options.duration || defaultDuration;\n\t\toptions.animateImmediately = options.animateImmediately || false;\n\n\t\tanimations[name] = {\n\t\t\tinit: init,\n\t\t\toptions: options,\n\t\t\targ: arg\n\t\t};\n\n\t\t//\tAdd a default binding for the name\n\t\tm.addBinding(name, function(prop){\n\t\t\tm.bindAnimation(name, this, arg, prop);\n\t\t}, true);\n\t};\n\n\n\t/*\tOptions - defaults - what it does:\n\n\t\tDelay - unedefined - delays the animation\n\t\tDirection - \n\t\tDuration\n\t\tFillMode - \"forward\" makes sure it sticks: http://www.w3schools.com/cssref/css3_pr_animation-fill-mode.asp\n\t\tIterationCount, \n\t\tName, PlayState, TimingFunction\n\t\n\t*/\n\n\t//\tUseful to know, 'to' and 'from': http://lea.verou.me/2012/12/animations-with-one-keyframe/\n\tm.animateKF = function(name, el, options, cb){\n\t\toptions = options || {};\n\t\tvar ani = animations[name], i, props = {};\n\t\tif(!ani) {\n\t\t\treturn err(\"Animation \" + name + \" not found.\");\n\t\t}\n\n\t\t//\tAllow override via options\n\t\tani.options = ani.options || {};\n\t\tfor(i in options) if(options.hasOwnProperty(i)) {{\n\t\t\tani.options[i] = options[i];\n\t\t}}\n\n\t\tif(!ani.isInitialised && ani.init) {\n\t\t\tani.init(ani.arg);\n\t\t}\n\n\t\t//\tAllow animate overrides\n\t\tfor(i in ani.options) if(ani.options.hasOwnProperty(i)) {{\n\t\t\tprops[vp(\"animation\" + cap(i))] = ani.options[i];\n\t\t}}\n\n\t\t//\tSet required items and default values for props\n\t\tprops[vp(\"animationName\")] = ani.id;\n\t\tprops[vp(\"animationDuration\")] = (props[vp(\"animationDuration\")]? props[vp(\"animationDuration\")]: defaultDuration) + \"ms\";\n\t\tprops[vp(\"animationDelay\")] = props[vp(\"animationDelay\")]? props[vp(\"animationDuration\")] + \"ms\": undefined;\n\t\tprops[vp(\"animationFillMode\")] = props[vp(\"animationFillMode\")] || \"forwards\";\n\n\t\tel.style = el.style || {};\n\n\t\t//\tUse for callback\n\t\tvar endAni = function(){\n\t\t\t//\tRemove listener\n\t\t\tel.removeEventListener(\"animationend\", endAni, false);\n\t\t\tif(cb){\n\t\t\t\tcb(el);\n\t\t\t}\n\t\t};\n\n\t\t//\tRemove animation if any\n\t\tel.style[vp(\"animation\")] = \"\";\n\t\tel.style[vp(\"animationName\")] = \"\";\n\n\t\t//\tMust use two request animation frame calls, for FF to\n\t\t//\twork properly, does not seem to have any adverse effects\n\t\trequestAnimationFrame(function(){\n\t\t\trequestAnimationFrame(function(){\n\t\t\t\t//\tApply props\n\t\t\t\tfor(i in props) if(props.hasOwnProperty(i)) {{\n\t\t\t\t\tel.style[i] = props[i];\n\t\t\t\t}}\n\n\t\t\t\tel.addEventListener(\"animationend\", endAni, false);\n\t\t\t});\n\t\t});\n\t};\n\n\tm.triggerKF = function(name, options){\n\t\treturn function(){\n\t\t\tm.animateKF(name, this, options);\n\t\t};\n\t};\n\n\tm.bindAnimation = function(name, el, options, prop) {\n\t\tvar ani = animations[name];\n\n\t\tif(!ani && !ani.name) {\n\t\t\treturn err(\"Animation \" + name + \" not found.\");\n\t\t}\n\n\t\tif(ani.fn) {\n\t\t\tm.animateProperties(el, ani.fn(prop));\n\t\t} else {\n\t\t\tvar oldConfig = el.config;\n\t\t\tel.config = function(el, isInit){\n\t\t\t\tif(!ani.isInitialised && ani.init) {\n\t\t\t\t\tani.init(options);\n\t\t\t\t}\n\t\t\t\tif(prop() && isInit) {\n\t\t\t\t\tm.animateKF(name, el, options);\n\t\t\t\t}\n\t\t\t\tif(oldConfig) {\n\t\t\t\t\toldConfig.apply(el, arguments);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t};\n\n\n\n\t/* Default transform2d bindings */\n\tvar basicBindings = ['scale', 'scalex', 'scaley', 'translate', 'translatex', 'translatey', \n\t\t'matrix', 'backgroundColor', 'backgroundPosition', 'borderBottomColor', \n\t\t'borderBottomWidth', 'borderLeftColor', 'borderLeftWidth', 'borderRightColor', \n\t\t'borderRightWidth', 'borderSpacing', 'borderTopColor', 'borderTopWidth', 'bottom', \n\t\t'clip', 'color', 'fontSize', 'fontWeight', 'height', 'left', 'letterSpacing', \n\t\t'lineHeight', 'marginBottom', 'marginLeft', 'marginRight', 'marginTop', 'maxHeight', \n\t\t'maxWidth', 'minHeight', 'minWidth', 'opacity', 'outlineColor', 'outlineWidth', \n\t\t'paddingBottom', 'paddingLeft', 'paddingRight', 'paddingTop', 'right', 'textIndent', \n\t\t'textShadow', 'top', 'verticalAlign', 'visibility', 'width', 'wordSpacing', 'zIndex'],\n\t\tdegBindings = ['rotate', 'rotatex', 'rotatey', 'skewx', 'skewy'], i;\n\n\t//\tBasic bindings where we pass the prop straight through\n\tfor(i = 0; i < basicBindings.length; i += 1) {\n\t\t(function(name){\n\t\t\tm.addAnimation(name, function(prop){\n\t\t\t\tvar options = {};\n\t\t\t\toptions[name] = prop();\n\t\t\t\treturn options;\n\t\t\t});\n\t\t}(basicBindings[i]));\n\t}\n\n\t//\tDegree based bindings - conditionally postfix with \"deg\"\n\tfor(i = 0; i < degBindings.length; i += 1) {\n\t\t(function(name){\n\t\t\tm.addAnimation(name, function(prop){\n\t\t\t\tvar options = {}, value = prop();\n\t\t\t\toptions[name] = isNaN(value)? value: value + \"deg\";\n\t\t\t\treturn options;\n\t\t\t});\n\t\t}(degBindings[i]));\n\t}\n\n\t//\tAttributes that require more than one prop\n\tm.addAnimation(\"skew\", function(prop){\n\t\tvar value = prop();\n\t\treturn {\n\t\t\tskew: [\n\t\t\t\tvalue[0] + (isNaN(value[0])? \"\":\"deg\"), \n\t\t\t\tvalue[1] + (isNaN(value[1])? \"\":\"deg\")\n\t\t\t]\n\t\t};\n\t});\n\n\n\n\t//\tA few more bindings\n\tm = m || {};\n\t//\tHide node\n\tm.addBinding(\"hide\", function(prop){\n\t\tthis.style = {\n\t\t\tdisplay: m.unwrap(prop)? \"none\" : \"\"\n\t\t};\n\t}, true);\n\n\t//\tToggle boolean value on click\n\tm.addBinding('toggle', function(prop){\n\t\tthis.onclick = function(){\n\t\t\tvar value = prop();\n\t\t\tprop(!value);\n\t\t}\n\t}, true);\n\n\t//\tSet hover states, a'la jQuery pattern\n\tm.addBinding('hover', function(prop){\n\t\tthis.onmouseover = prop[0];\n\t\tif(prop[1]) {\n\t\t\tthis.onmouseout = prop[1];\n\t\t}\n\t}, true );\n\n\n};\n\n\n\n\n\n\n\nif (typeof module != \"undefined\" && module !== null && module.exports) {\n\tmodule.exports = mithrilAnimate;\n} else if (typeof define === \"function\" && define.amd) {\n\tdefine(function() {\n\t\treturn mithrilAnimate;\n\t});\n} else {\n\tmithrilAnimate(typeof window != \"undefined\"? window.m || {}: {});\n}\n\n}());","/*\tmiso permissions\n\tPermit users access to controller actions based on roles \n*/\nvar miso = require('../server/miso.util.js'),\n\thasRole = function(userRoles, roles){\n\t\tvar hasRole = false;\n\t\t//\tAll roles\n\t\tif(userRoles == \"*\") {\n\t\t\treturn true;\n\t\t}\n\t\t//\tSearch each user role\n\t\tmiso.each(userRoles, function(userRole){\n\t\t\tuserRole = (typeof userRole !== \"string\")? userRole: [userRole];\n\t\t\t//\tSearch each role\n\t\t\tmiso.each(roles, function(role){\n\t\t\t\tif(userRole == role) {\n\t\t\t\t\thasRole = true;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\treturn hasRole;\n\t};\n\n//\tDetermine if the user has access to an APP action\n//\tTODO: \nmodule.exports.app = function(permissions, actionName, userRoles){\n\t//\tTODO: Probably need to use pass=false by default, but first:\n\t//\n\t//\t* Add global config for pass default in server.json\n\t//\t* \n\t//\n\tvar pass = true;\n\n\t//\tApply deny first, then allow.\n\tif(permissions && userRoles){\n\t\tif(permissions.deny) {\n\t\t\tpass = ! hasRole(user.roles, permissions.deny);\n\t\t}\n\t\tif(permissions.allow) {\n\t\t\tpass = hasRole(user.roles, permissions.allow);\n\t\t}\n\t}\n\n\treturn pass;\n};\n\n\n//\tDetermine if the user has access to an API action\n//\tTODO: \nmodule.exports.api = function(permissions, actionName, userRoles){\n\t//\tTODO: Probably need to use pass=false by default, but first:\n\t//\n\t//\t* Add global config for pass default in server.json\n\t//\t* \n\t//\n\tvar pass = true;\n\n\t//\tApply deny first, then allow.\n\tif(permissions && userRoles){\n\t\tif(permissions.deny) {\n\t\t\tpass = ! hasRole(user.roles, permissions.deny);\n\t\t}\n\t\tif(permissions.allow) {\n\t\t\tpass = hasRole(user.roles, permissions.allow);\n\t\t}\n\t}\n\n\treturn pass;\n};","//\tSetup authentication\n//\n//\tTODO:\n//\t\n//\t* Ability to redirect to login page\n//\t* Ability to send JSON RPC 2.0 response\n//\t* NOTE: Need to:\n//\t\t- setup JSON RPC 2.0 for all API calls\n//\t\t- create a generic message handler\n//\n//\nmodule.exports = function(app, secret){\n\t//\toptions are passed in from the mvc action, eg: user.edit\n\t//\thas an example\n\treturn function(options) {\n\t\tconsole.log('auth options', options);\n\t\treturn function(req, res, next) {\n\t\t\tvar sess = req.session;\n\n\t\t\tconsole.log('authing...', sess);\n\n\t\t\t//\tWe are authenticated\n\t\t\tif(sess && sess.authenticated === secret) {\n\t\t\t\treturn next();\n\t\t\t} else {\n\n\t\t\t\tconsole.log('not auth', req.originalUrl);\n\n\t\t\t\tif(options.requestType == \"JSON\") {\n\t\t\t\t\t//\tRespond with JSON RPC 2.0\n\t\t\t\t} else {\n\t\t\t\t\t//\tRedirect to login action, pass in req.originalUrl so the user can do somethign with it\n\t\t\t\t\treturn res.redirect(\"/login?url=\" + req.originalUrl);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t};\n};","/*\n\tThis is a sample user management app that uses the\n\tmultiple url miso pattern.\n*/\nvar miso = require('../server/miso.util.js'),\n\tvalidate = require('validator.modelbinder'),\n\tm = require('mithril'),\n\tsugartags = require('mithril.sugartags')(m),\n\tbindings = require('../server/mithril.bindings.node.js')(m),\n\tapi = require(\"../system/adaptor/flatfiledb/api.client.js\")(m),\n\tlapi = require(\"../modules/adaptor/authentication/api.client.js\")(m);\n\nlapi.find({type: 'user.edit.user'}).then(function(data) {\n\tconsole.log(data);\n});\n\nvar self = module.exports;\n\n//\tShared view\nvar editView = function(ctrl){\n\twith(sugartags) {\n\t\treturn DIV({ class: \"cw\" }, [\n\t\t\tH2({\"class\": \"pageHeader\"}, ctrl.header),\n\t\t\tctrl.user ? [\n\t\t\t\tDIV([\n\t\t\t\t\tLABEL(\"Name\"), INPUT({value: ctrl.user.name}),\n\t\t\t\t\tDIV({\"class\": (ctrl.user.isValid('name') == true || !ctrl.showErrors? \"valid\": \"invalid\") + \" indented\"}, [\n\t\t\t\t\t\tctrl.user.isValid('name') == true || !ctrl.showErrors? \"\": ctrl.user.isValid('name').join(\", \")\n\t\t\t\t\t])\n\t\t\t\t]),\n\t\t\t\tDIV([\n\t\t\t\t\tLABEL(\"Email\"), INPUT({value: ctrl.user.email}),\n\t\t\t\t\tDIV({\"class\": (ctrl.user.isValid('email') == true || !ctrl.showErrors? \"valid\": \"invalid\") + \" indented\" }, [\n\t\t\t\t\t\tctrl.user.isValid('email') == true || !ctrl.showErrors? \"\": ctrl.user.isValid('email').join(\", \")\n\t\t\t\t\t])\n\t\t\t\t]),\n\t\t\t\tDIV([\n\t\t\t\t\tLABEL(\"Password\"), INPUT({value: ctrl.user.password, type: 'password'}),\n\t\t\t\t\tDIV({\"class\": (ctrl.user.isValid('password') == true || !ctrl.showErrors? \"valid\": \"invalid\") + \" indented\" }, [\n\t\t\t\t\t\tctrl.user.isValid('password') == true || !ctrl.showErrors? \"\": ctrl.user.isValid('password').join(\", \")\n\t\t\t\t\t])\n\t\t\t\t]),\n\t\t\t\tDIV({\"class\": \"indented\"},[\n\t\t\t\t\tBUTTON({onclick: ctrl.save, class: \"positive\"}, \"Save user\"),\n\t\t\t\t\tBUTTON({onclick: ctrl.remove, class: \"negative\"}, \"Delete user\")\n\t\t\t\t])\n\t\t\t]: DIV(\"User not found\")\n\t\t]);\n\t}\n};\n\n\n//\tUser list\nmodule.exports.index = {\n\tcontroller: function(params) {\n\t\tvar ctrl = this;\n\n\t\tctrl.vm = {\n\t\t\tuserList: function(users){\n\t\t\t\tthis.users = m.p(users);\n\t\t\t}\n\t\t};\n\n\t\tapi.find({type: 'user.edit.user'}).then(function(data) {\n\t\t\tif(data.error) {\n\t\t\t\tconsole.log(\"Error \" + data.error);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif(data.result) {\n\t\t\t\tvar list = Object.keys(data.result).map(function(key) {\n\t\t\t\t\treturn new self.edit.models.user(data.result[key]);\n\t\t\t\t});\n\n\t\t\t\tctrl.users = new ctrl.vm.userList(list);\n\t\t\t} else {\n\t\t\t\tctrl.users = new ctrl.vm.userList([]);\n\t\t\t}\n\t\t}, function(){\n\t\t\tconsole.log('Error', arguments);\n\t\t});\n\n\t\treturn this;\n\t},\n\tview: function(ctrl){\n\t\tvar c = ctrl,\n\t\t\tu = c.users;\n\n\t\twith(sugartags) {\n\t\t\treturn DIV({ class: \"cw\" }, [\n\t\t\t\tUL([\n\t\t\t\t\tu.users().map(function(user, idx){\n\t\t\t\t\t\treturn LI(A({ href: '/user/' + user.id(), config: m.route}, user.name() + \" - \" + user.email()));\n\t\t\t\t\t})\n\t\t\t\t]),\n\t\t\t\tA({\"class\":\"button positive mtop\", href:\"/users/new\", config: m.route}, \"Add new user\")\n\t\t\t]);\n\t\t}\n\t}\n};\n\n\n//\tNew user\nmodule.exports.new = {\n\tcontroller: function(params) {\n\t\tvar ctrl = this;\n\t\tctrl.user = new self.edit.models.user({name: \"\", email: \"\"});\n\t\tctrl.header = \"New user\";\n\t\tctrl.showErrors = false;\n\n\t\tctrl.save = function(){\n\t\t\tif(ctrl.user.isValid() !== true) {\n\t\t\t\tctrl.showErrors = true;\n\t\t\t\tconsole.log('User is not valid');\n\t\t\t} else {\n\t\t\t\tapi.save({ type: 'user.edit.user', model: ctrl.user } ).then(function(){\n\t\t\t\t\tconsole.log(\"Added user\", arguments);\n\t\t\t\t\tm.route(\"/users\");\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\treturn ctrl;\n\t},\n\tview: editView\n};\n\n\n//\tEdit user\nmodule.exports.edit = {\n\tmodels: {\n\t\tuser: function(data){\n\t\t\tthis.name = m.p(data.name||\"\");\n\t\t\tthis.email = m.p(data.email||\"\");\n\t\t\tthis.password = m.p(data.password||\"\");\n\t\t\tthis.id = m.p(data._id||\"\");\n\n\t\t\t//\tValidate the model\n\t\t\tthis.isValid = validate.bind(this, {\n\t\t\t\tname: {\n\t\t\t\t\tisRequired: \"You must enter a name\"\n\t\t\t\t},\n\t\t\t\tpassword: {\n\t\t\t\t\tisRequired: \"You must enter a password\"\n\t\t\t\t},\n\t\t\t\temail: {\n\t\t\t\t\tisRequired: \"You must enter an email address\",\n\t\t\t\t\tisEmail: \"Must be a valid email address\"\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn this;\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tvar ctrl = this,\n\t\t\tuserId = miso.getParam('user_id', params);\n\n\t\tctrl.header = \"Edit user \" + userId;\n\n\t\t//\tLoad our user\n\t\tapi.find({type: 'user.edit.user', query: {_id: userId}}).then(function(data) {\n\t\t\tvar user = data.result;\n\t\t\tif(user && user.length > 0) {\n\t\t\t\tctrl.user = new self.edit.models.user(user[0]);\n\t\t\t} else {\n\t\t\t\tconsole.log('User not found', userId);\n\t\t\t}\n\t\t}, function(){\n\t\t\tconsole.log('Error', arguments);\n\t\t});\n\n\t\tctrl.save = function(){\n\t\t\tif(ctrl.user.isValid() !== true) {\n\t\t\t\tctrl.showErrors = true;\n\t\t\t\tconsole.log('User is not valid');\n\t\t\t} else {\n\t\t\t\tapi.save({ type: 'user.edit.user', model: ctrl.user } ).then(function(){\n\t\t\t\t\tconsole.log(\"Saved user\", arguments);\n\t\t\t\t\tm.route(\"/users\");\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\tctrl.remove = function(){\n\t\t\tif(confirm(\"Delete user?\")) {\n\t\t\t\tapi.remove({ type: 'user.edit.user', _id: userId }).then(function(data){\n\t\t\t\t\tconsole.log(data.result);\n\t\t\t\t\tm.route(\"/users\");\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t\treturn ctrl;\n\t},\n\tview: editView\n\t//\tAny authentication info\n\t//, authenticate: true\n};\n","var m = require('mithril'),\n\tsugartags = require('mithril.sugartags')(m),\n\tsmoothScroll = require('../client/js/mithril.smoothscroll.js');\n\n//\tHome page\nvar self = module.exports.index = {\n\tmodels: {\n\t\tintro: function() {\n\t\t\tthis.text = m.p(\"Create apps in a snap!\");\n\t\t\tthis.ani = m.p(0);\n\t\t\tthis.demoImgSrc = m.p(\"img/misodemo.gif\");\n\t\t}\n\t},\n\tcontroller: function(){\n\t\tvar ctrl = this;\n\n\t\tctrl.replay = function(){\n\t\t\tvar tmpSrc = ctrl.model.demoImgSrc();\n\t\t\tctrl.model.demoImgSrc(\"\");\n\t\t\tsetTimeout(function(){\n\t\t\t\tctrl.model.demoImgSrc(tmpSrc);\n\t\t\t},0);\n\t\t};\n\n\t\tctrl.model = new self.models.intro();\n\t\treturn this;\n\t},\n\n\tview: function(ctrl){\n\t\tvar o = ctrl.model;\n\t\twith(sugartags) {\n\t\t\treturn DIV([\n\t\t\t\tDIV({\"class\": \"intro\"}, [\n\t\t\t\t\tDIV({\"class\": \"introText\"}, o.text()),\n\t\t\t\t\tDIV({\"class\": \"demoImg\"}, [\n\t\t\t\t\t\tIMG({id: \"demoImg\", src: o.demoImgSrc()}),\n\t\t\t\t\t\tSPAN({\"class\": \"replayButton\", onclick: ctrl.replay}, \"Replay\")\n\t\t\t\t\t]),\n\t\t\t\t\tA({\"class\": \"installButton\", config: smoothScroll(ctrl), href: \"#installation\"}, \"Install miso now\")\n\t\t\t\t]),\n\n\t\t\t\tDIV({\"class\": \"cw\"}, [\n\t\t\t\t\tH2(A({name: \"what\", \"class\": \"heading\"},\"What is miso?\") ),\n\t\t\t\t\tP(\"Miso is an open source isomorphic javascript framework that allows you to write complete apps with much less effort than other frameworks. Miso features:\",[\n\t\t\t\t\t\tUL({\"class\": \"dotList\"}, [\n\t\t\t\t\t\t\tLI(\"Single page apps with serverside rendered HTML for the first page - works perfectly with SEO and older browsers\"),\n\t\t\t\t\t\t\tLI(\"Beautiful URLs - with a flexible routing system: automate some routes, take full control of others\"),\n\t\t\t\t\t\t\tLI(\"Tiny clientside footprint - less than 25kb (gzipped and minified)\"),\n\t\t\t\t\t\t\tLI(\"Fast live-code reload - smarter reload to help you work faster\"),\n\t\t\t\t\t\t\tLI([\"High performance - virtual dom engine, tiny footprint, faster than the rest\", A({href: \"http://lhorie.github.io/mithril/benchmarks.html\", target: \"_blank\"}, \"*\")]),\n\t\t\t\t\t\t\tLI(\"Much less code - create a deployable app in less than 30 lines of code\"),\n\t\t\t\t\t\t\tLI(\"Open source - MIT licensed\")\n\t\t\t\t\t\t])\n\t\t\t\t\t]),\n\t\t\t\t\tP(\"Miso utilises excellent open source libraries and frameworks to create an extremely efficient full web stack. These frameworks include:\"),\n\t\t\t\t\tDIV({\"class\": \"frameworks\"}, [\n\t\t\t\t\t\tDIV({\"class\": \"fwcontainer cf\"},[\n\t\t\t\t\t\t\tA({\"class\": \"fwLink\", href: \"http://lhorie.github.io/mithril/\", target: \"_blank\"},\n\t\t\t\t\t\t\tSPAN({\"class\": \"fw mithril\"})),\n\t\t\t\t\t\t\tA({\"class\": \"fwLink\", href: \"http://expressjs.com/\", target: \"_blank\"},SPAN({\"class\": \"fw express\"})),\n\t\t\t\t\t\t\tA({\"class\": \"fwLink\", href: \"http://browserify.org/\", target: \"_blank\"},SPAN({\"class\": \"fw browserify\"})),\n\t\t\t\t\t\t\tA({\"class\": \"fwLink\", href: \"http://nodemon.io/\", target: \"_blank\"},SPAN({\"class\": \"fw nodemon\"}))\n\t\t\t\t\t\t])\n\t\t\t\t\t])\n\t\t\t\t]),\n\n\t\t\t\tDIV({\"class\": \"cw\"}, [\n\t\t\t\t\tH2({id: \"installation\"}, A({name: \"installation\", \"class\": \"heading\"},\"Installation\") ),\n\t\t\t\t\tP(\"To install miso, use npm:\"),\n\t\t\t\t\tPRE({\"class\": \"javascript\"},[\n\t\t\t\t\t\tCODE(\"npm install misojs -g\")\n\t\t\t\t\t])\n\t\t\t\t]),\n\n\t\t\t\tDIV({\"class\": \"cw\"}, [\n\t\t\t\t\tH2(A({name: \"gettingstarted\", \"class\": \"heading\"},\"Getting started\") ),\n\t\t\t\t\tP(\"To create and run a miso app in a new directory:\"),\n\t\t\t\t\tPRE({\"class\": \"javascript\"},[\n\t\t\t\t\t\tCODE(\"miso -n myApp\\ncd myApp\\nmiso run\")\n\t\t\t\t\t]),\n\t\t\t\t\tP(\"Congratulations, you are now running your very own miso app in the 'myApp' directory!\")\n\t\t\t\t]),\n\n\t\t\t\tDIV({\"class\": \"cw\"}, [\n\t\t\t\t\tH2(A({name: \"examples\", \"class\": \"heading\"},\"Examples\")),\n\t\t\t\t\tUL([\n\t\t\t\t\t\tLI(A({ href: '/todos', config: m.route}, \"Todos example (single url SPA)\")),\n\t\t\t\t\t\tLI(A({ href: '/users', config: m.route}, \"Users example (multiple url SPA)\"))\n\t\t\t\t\t]),\n\t\t\t\t\tH2({name: \"documentation\", \"class\": \"heading\"}, \"Documentation\"),\n\t\t\t\t\tA({href:\"https://github.com/jsguy/misojs/wiki\", target: \"_blank\"}, \"Documentation can be found on the wiki\")\n\t\t\t\t])\n\t\t\t]);\n\t\t}\n\t}\n};\n","var m = require('mithril'),\n\tmiso = require('../server/miso.util.js'),\n\tsugartags = require('mithril.sugartags')(m),\n\t//\tGrab the generated client version...\n\tdocs = require('../client/miso.documentation.js');\n\nvar index = module.exports.index = {\n\tmodels: {\n\t\t//\tOur model\n\t\tdocs: function(data){\n\t\t\tthis.docs = data.docs;\n\t\t\tthis.id = data.id;\n\t\t\tthis.niceName = function(name){\n\t\t\t\treturn name.substr(0,name.lastIndexOf(\".md\")).split(\"-\").join(\" \");\n\t\t\t};\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tthis.model = new index.models.docs({\n\t\t\tdocs: docs()\n\t\t});\n\t\treturn this;\n\t},\n\tview: function(ctrl) {\n\t\tvar model = ctrl.model;\n\t\twith(sugartags) {\n\t\t\treturn DIV({\"class\": \"doc cw\"}, [\n\t\t\t\tDIV(\"Below is a list of documentation for miso:\"),\n\t\t\t\tUL([\n\t\t\t\t\tmiso.each(model.docs, function(doc, key){\n\t\t\t\t\t\t//\tSkip home page...\n\t\t\t\t\t\tif(key !== \"Home.md\") {\n\t\t\t\t\t\t\treturn LI(\n\t\t\t\t\t\t\t\tA({href: \"/doc/\" + key, config: m.route}, model.niceName(key))\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} \n\t\t\t\t\t})\n\t\t\t\t]),\n\t\t\t\tDIV(\"Examples:\"),\n\t\t\t\tUL([\n\t\t\t\t\tLI(A({href: \"/todos\", config: m.route}, \"Todos example\")),\n\t\t\t\t\tLI(A({href: \"/users\", config: m.route}, \"Users example\"))\n\t\t\t\t]),\n\t\t\t\t//\tUse manual prism, so that it works in SPA mode\n\t\t\t\tSCRIPT({src: \"/external/prism/prism.js\", \"data-manual\": \"\"})\n\t\t\t]);\n\t\t}\n\t}\n};\n\nvar edit = module.exports.edit = {\n\tcontroller: function(params) {\n\t\tvar doc_id = miso.getParam('doc_id', params);\n\t\tthis.model = new index.models.docs({\n\t\t\tdocs: docs(),\n\t\t\tid: doc_id\n\t\t});\n\t\treturn this;\n\t},\n\tview: function(ctrl) {\n\t\tvar model = ctrl.model;\n\t\twith(sugartags) {\n\t\t\treturn DIV({\"class\": \"doc cw\"}, [\n\t\t\t\tLINK({href: \"/external/prism/prism.css\", rel: \"stylesheet\"}),\n\t\t\t\tH1(model.niceName(model.id)),\n\t\t\t\tARTICLE(m.trust(model.docs[model.id])),\n\t\t\t\t//\tUse manual prism, so that it works in SPA mode\n\t\t\t\tSCRIPT({src: \"/external/prism/prism.js\", \"data-manual\": \"\"}),\n\t\t\t\tSCRIPT(\"Prism.highlightAll();\")\n\t\t\t]);\n\t\t}\n\t}\n};","var m = require('mithril'),\n\tmiso = require('../server/miso.util.js'),\n\tsugartags = require('mithril.sugartags')(m),\n\tflickr = require(\"../modules/adaptor/flickr/api.client.js\")(m);\n\nvar index = module.exports.index = {\n\tmodels: {\n\t\tpics: function(data){\n\t\t\tthis.flickrData = m.prop(data.flickrData);\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tvar ctrl = this;\n\t\tflickr.photos({tags: \"Sydney opera house\", tagmode: \"any\"}).then(function(data){\n\t\t\tctrl.model.flickrData(data.result.items);\n\t\t});\n\t\tctrl.model = new index.models.pics({flickrData: {}});\n\t\treturn ctrl;\n\t},\n\tview: function(ctrl) {\n\t\twith(sugartags) {\n\t\t\treturn DIV([\n\t\t\t\tmiso.each(ctrl.model.flickrData(), function(item){\n\t\t\t\t\treturn IMG({src: item.media.m});\n\t\t\t\t})\n\t\t\t]);\n\t\t}\n\t}\n};","var m = require('mithril'),\n\tmiso = require('../server/miso.util.js'),\n\tsugartags = require('mithril.sugartags')(m);\n\nvar edit = module.exports.edit = {\n\tmodels: {\n\t\thello: function(data){\n\t\t\tthis.who = m.prop(data.who);\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tvar who = miso.getParam('hello_id', params);\n\t\tthis.model = new edit.models.hello({who: who});\n\t\treturn this;\n\t},\n\tview: function(ctrl) {\n\t\twith(sugartags) {\n\t\t\treturn DIV(\"G'day \" + ctrl.model.who());\n\t\t}\n\t}\n};","/* Example login mvc */\nvar m = require('mithril'),\n\tmiso = require('../server/miso.util.js'),\n\tsugartags = require('mithril.sugartags')(m),\n\tldb = require(\"../modules/adaptor/authentication/api.client.js\")(m);\n\nvar index = module.exports.index = {\n\tmodels: {\n\t\tlogin: function(data){\n\t\t\tthis.url = data.url;\n\t\t\tthis.username = m.prop(data.username||\"\");\n\t\t\tthis.password = m.prop(\"\");\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tvar ctrl = this,\n\t\t\turl = miso.getParam('url', params);\n\n\t\tctrl.model = new index.models.login({url: url});\n\n\t\tctrl.login = function(e){\n\t\t\te.preventDefault();\n\t\t\tldb.login({type: 'login.index.login', model: ctrl.model}).then(function(data){\n\t\t\t\tconsole.log('response', data);\n\t\t\t});\n\t\t\treturn false;\n\t\t}\n\n\t\treturn ctrl;\n\t},\n\tview: function(ctrl) {\n\t\twith(sugartags) {\n\t\t\treturn [\n\t\t\t\tDIV(\"G'day, you need to log in to go to \" + ctrl.model.url),\n\t\t\t\tFORM({ onsubmit: ctrl.login }, [\n\t\t\t\t\tINPUT({ type: \"text\", value: ctrl.model.username, placeholder: \"Username\"}),\n\t\t\t\t\tINPUT({ type: \"password\", value: ctrl.model.password}),\n\t\t\t\t\tBUTTON({ type: \"submit\"}, \"Login\")\n\t\t\t\t])\n\t\t\t]\n\t\t}\n\t}\n};","var m = require('mithril'),\n\tsugartags = require('mithril.sugartags')(m),\n\tdb = require(\"../system/adaptor/flatfiledb/api.client.js\")(m);\n\nvar self = module.exports.index = {\n\tmodels: {\n\t\ttodo: function(data){\n\t\t\tthis.text = data.text;\n\t\t\tthis.done = m.prop(data.done == \"false\"? false: data.done);\n\t\t\tthis._id = data._id;\n\t\t}\n\t},\n\tcontroller: function(params) {\n\t\tvar ctrl = this;\n\n\t\tctrl.list = [];\n\n\t\tdb.find({type: 'todo.index.todo'}, {background: true, initialValue: []}).then(function(data) {\n\t\t\tctrl.list = Object.keys(data.result).map(function(key) {\n\t\t\t\treturn new self.models.todo(data.result[key]);\n\t\t\t});\n\t\t});\n\n\t\tctrl.addTodo = function(e){\n\t\t\tvar value = ctrl.vm.input();\n\t\t\tif(value) {\n\t\t\t\tvar newTodo = new self.models.todo({\n\t\t\t\t\ttext: ctrl.vm.input(),\n\t\t\t\t\tdone: false\n\t\t\t\t});\n\t\t\t\tctrl.list.push(newTodo);\n\t\t\t\tctrl.vm.input(\"\");\n\t\t\t\tdb.save({ type: 'todo.index.todo', model: newTodo } ).then(function(res){\n\t\t\t\t\tnewTodo._id = res.result;\n\t\t\t\t});\n\t\t\t}\n\t\t\te.preventDefault();\n\t\t\treturn false;\n\t\t};\n\n\t\tctrl.archive = function(){\n\t\t\tvar list = [];\n\t\t\tctrl.list.map(function(todo) {\n\t\t\t\tif(!todo.done()) {\n\t\t\t\t\tlist.push(todo); \n\t\t\t\t} else {\n\t\t\t\t\tdb.remove({ type: 'todo.index.todo', _id: todo._id }).then(function(response){\n\t\t\t\t\t\tconsole.log(response.result);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\tctrl.list = list;\n\t\t};\n\n\t\tctrl.vm = {\n\t\t\tleft: function(){\n\t\t\t\tvar count = 0;\n\t\t\t\tctrl.list.map(function(todo) {\n\t\t\t\t\tcount += todo.done() ? 0 : 1;\n\t\t\t\t});\n\t\t\t\treturn count;\n\t\t\t},\n\t\t\tdone: function(todo){\n\t\t\t\treturn function() {\n\t\t\t\t\ttodo.done(!todo.done());\n\t\t\t\t}\n\t\t\t},\n\t\t\tinput: m.prop(\"\")\n\t\t};\n\n\t\treturn ctrl;\n\t},\n\tview: function(ctrl) {\n\t\twith(sugartags) {\n\t\t\treturn [\n\t\t\t\tSTYLE(\".done{text-decoration: line-through;}\"),\n\t\t\t\tH1(\"Todos - \" + ctrl.vm.left() + \" of \" + ctrl.list.length + \" remaining\"),\n\t\t\t\tBUTTON({ onclick: ctrl.archive }, \"Archive\"),\n\t\t\t\tUL([\n\t\t\t\t\tctrl.list.map(function(todo){\n\t\t\t\t\t\treturn LI({ class: todo.done()? \"done\": \"\", onclick: ctrl.vm.done(todo) }, todo.text);\n\t\t\t\t\t})\n\t\t\t\t]),\n\t\t\t\tFORM({ onsubmit: ctrl.addTodo }, [\n\t\t\t\t\tINPUT({ type: \"text\", value: ctrl.vm.input, placeholder: \"Add todo\"}),\n\t\t\t\t\tBUTTON({ type: \"submit\"}, \"Add\")\n\t\t\t\t])\n\t\t\t]\n\t\t};\n\t}\n\t//\tTest authenticate\n\t,authenticate: true\n};","//\tVarious utilities that normalise usage between client and server\n//\tThis is the client version\n//\tSee /server/miso.util.js for server version\nvar m = require('mithril');\n\nmodule.exports = {\n\t//\tAre we on the server?\n\tisServer: function() {\n\t\treturn false;\n\t},\n\t\n\t//\tEach abstraction\n\t//\t\n\t//\tmiso.each(['hello', 'world'], function(value, key){\n\t//\t\tconsole.log(value, key);\n\t//\t});\n\t//\t//\thello 0\\nhello 1\n\t//\n\t// \tmiso.each({'hello': 'world'}, function(value, key){\n\t//\t\tconsole.log(value, key);\n\t//\t});\n\t//\t//\tworld hello\n\t//\n\teach: function(obj, fn) {\n\t\tif(Object.prototype.toString.call(obj) === '[object Array]' ) {\n\t\t\treturn obj.map(fn);\n\t\t} else if(typeof obj == 'object') {\n\t\t\treturn Object.keys(obj).map(function(key){\n\t\t\t\treturn fn(obj[key], key);\n\t\t\t});\n\t\t} else {\n\t\t\treturn fn(obj);\n\t\t}\n\t},\n\n\treadyBinder: function(){\n\t\tvar bindings = [];\n\t\treturn {\n\t\t\tbind: function(cb) {\n\t\t\t\tbindings.push(cb);\n\t\t\t},\n\t\t\tready: function(){\n\t\t\t\tfor(var i = 0; i < bindings.length; i += 1) {\n\t\t\t\t\tbindings[i]();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t},\n\t//\tGet parameters for an action\n\tgetParam: function(key, params, def){\n\t\treturn typeof m.route.param(key) !== \"undefined\"? m.route.param(key): def;\n\t}\n};","/* NOTE: This is a generated file, please do not modify it, your changes will be lost */\nmodule.exports = function(m){\n\tvar getModelData = function(model){\n\t\tvar i, result = {};\n\t\tfor(i in model) {if(model.hasOwnProperty(i)) {\n\t\t\tif(i !== 'isValid') {\n\t\t\t\tif(i == 'id') {\n\t\t\t\t\tresult['_id'] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t} else {\n\t\t\t\t\tresult[i] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t}\n\t\t\t}\n\t\t}}\n\t\treturn result;\n\t};\n\treturn {\n'find': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/flatfiledb/find',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n},\n'save': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/flatfiledb/save',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n},\n'remove': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/flatfiledb/remove',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n}\n\t};\n};","/* NOTE: This is a generated file, please do not modify it, your changes will be lost */\nmodule.exports = function(m){\n\tvar getModelData = function(model){\n\t\tvar i, result = {};\n\t\tfor(i in model) {if(model.hasOwnProperty(i)) {\n\t\t\tif(i !== 'isValid') {\n\t\t\t\tif(i == 'id') {\n\t\t\t\t\tresult['_id'] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t} else {\n\t\t\t\t\tresult[i] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t}\n\t\t\t}\n\t\t}}\n\t\treturn result;\n\t};\n\treturn {\n'find': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/authentication/find',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n},\n'save': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/authentication/save',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n},\n'remove': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/authentication/remove',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n}\n\t};\n};","//  Smooth scrolling for links\n//  Usage:      A({config: smoothScroll(ctrl), href: \"#top\"}, \"Back to top\")\nmodule.exports = function(ctrl){\n\t//var root = (typeof document !== 'undefined')? document.body || document.documentElement: this,\n\tvar root = (typeof navigator !== 'undefined')? /firefox|trident/i.test(navigator.userAgent) ? document.documentElement : document.body: null,\n\t\teaseInOutSine = function (t, b, c, d) {\n\t\t\t//  http://gizma.com/easing/\n\t\t\treturn -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;\n\t\t};\n\n\treturn function(element, isInitialized) {\n\t\tif(!isInitialized) {\n\t\t\telement.addEventListener(\"click\", function(e) {\n\t\t\t\tvar startTime,\n\t\t\t\t\tstartPos = root.scrollTop,\n\t\t\t\t\tendPos = document.getElementById(/[^#]+$/.exec(this.href)[0]).getBoundingClientRect().top,\n\t\t\t\t\thash = this.href.substr(this.href.lastIndexOf(\"#\")),\n\t\t\t\t\tmaxScroll = root.scrollHeight - window.innerHeight,\n\t\t\t\t\tscrollEndValue = (startPos + endPos < maxScroll)? endPos: maxScroll - startPos,\n\t\t\t\t\tduration = typeof ctrl.duration !== 'undefined'? ctrl.duration: 1500,\n\t\t\t\t\tscrollFunc = function(timestamp) {\n\t\t\t\t\t\tstartTime = startTime || timestamp;\n\t\t\t\t\t\tvar elapsed = timestamp - startTime,\n\t\t\t\t\t\t\tprogress = easeInOutSine(elapsed, startPos, scrollEndValue, duration);\n\t\t\t\t\t\troot.scrollTop = progress;\n\t\t\t\t\t\tif(elapsed < duration) {\n\t\t\t\t\t\t\trequestAnimationFrame(scrollFunc);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif(history.pushState) {\n\t\t\t\t\t\t\t\thistory.pushState(null, null, hash);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlocation.hash = hash;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(scrollFunc)\n\t\t\t\te.preventDefault();\n\t\t\t});\n\t\t}\n\t};\n};","module.exports = function(){ return {\"Creating-a-todo-app.md\":\"<p>In this article we will create a fully functional todo app, complete with details of how to use the database API and persisting/loading your data. We recommend you first read the [Getting started] article, and understand the miso fundamentals such as where to place models and how to creating a miso controller. Please do that first, it only takes 2 minutes.</p>\\n<h2><a name=\\\"todo-app\\\" class=\\\"anchor\\\" href=\\\"#todo-app\\\"><span class=\\\"header-link\\\">Todo app</span></a></h2><p>We will now create a new app using the <a href=\\\"/doc/Patterns#single-url-mvc.md\\\">single url pattern</a>, which means it handles all actions autonomously, plus looks a lot like a normal mithril app.</p>\\n<p>In <code>/mvc</code> save a new file as <code>todo.js</code> with the following content: </p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;);\\n\\nvar self = module.exports.index = {\\n    models: {},\\n    controller: function(params) {\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        return &quot;TODO&quot;;\\n    }\\n};\\n</code></pre>\\n<p>Now open: <a href=\\\"/doc/todos.md\\\">http://localhost:6476/todos</a> and you&#39;ll see the word &quot;TODO&quot;. You&#39;ll notice that the url is &quot;/todos&quot; with an &#39;s&#39; on the end - as we are using <a href=\\\"/doc/How-miso-works#route-by-convention.md\\\">route by convention</a> to map our route.</p>\\n<p>Next let&#39;s create the model for our todos - change the <code>models</code> attribute to the following:</p>\\n<pre><code class=\\\"lang-javascript\\\">models: {\\n    //    Our todo model\\n    todo: function(data){\\n        this.text = data.text;\\n        this.done = m.p(data.done == &quot;false&quot;? false: data.done);\\n        this._id = data._id;\\n    }\\n},\\n</code></pre>\\n<p>Each line in the model does the following:</p>\\n<ul>\\n<li><code>this.text</code> - The text that is shown on the todo</li>\\n<li><code>this.data</code> - This represents if the todo has been completed - we ensure that we handle the &quot;false&quot; values correctly, as ajax responses are always strings.</li>\\n<li><code>this._id</code> - The key for the todo - you must use <code>_id</code> for this</li>\\n</ul>\\n<p>The model can now be used to store and retreive todos - miso automatically picks up any objects on the <code>models</code> attribute of your mvc file, and maps it in the API. We will soon see how that works. Next add the following code as the controller:</p>\\n<pre><code class=\\\"lang-javascript\\\">controller: function(params) {\\n    var myTodos = [{text: &quot;Learn miso&quot;}, {text: &quot;Build miso app&quot;}];\\n    this.list = Object.keys(myTodos).map(function(key) {\\n        return new self.models.todo(myTodos[key]);\\n    });\\n    return this;\\n},\\n</code></pre>\\n<p>This does the following:</p>\\n<ul>\\n<li>Creates <code>myTodos</code> which is a list of objects that represents todos</li>\\n<li><code>this.list</code> - creates a list of todo model objects by using <code>new self.models.todo(...</code> on each myTodos object.</li>\\n<li><code>return this</code> must be done in all controllers, it makes sure that miso can correctly get access to the controller object.</li>\\n</ul>\\n<p>Now update the view like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">view: function(ctrl) {\\n    return m(&quot;UL&quot;, [\\n        ctrl.list.map(function(todo){\\n            return m(&quot;LI&quot;, todo.text)\\n        })\\n    ]);\\n}\\n</code></pre>\\n<p>This will iterate on your newly created list of todo model objects and display the on screen. Your complete program should look like this:</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;);\\n\\nvar self = module.exports.index = {\\n    models: {\\n        //    Our todo model\\n        todo: function(data){\\n            this.text = data.text;\\n            this.done = m.p(data.done == &quot;false&quot;? false: data.done);\\n            this._id = data._id;\\n        }\\n    },\\n    controller: function(params) {\\n        var myTodos = [{text: &quot;Learn miso&quot;}, {text: &quot;Build miso app&quot;}];\\n        this.list = Object.keys(myTodos).map(function(key) {\\n            return new self.models.todo(myTodos[key]);\\n        });\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        return m(&quot;UL&quot;, [\\n            ctrl.list.map(function(todo){\\n                return m(&quot;LI&quot;, todo.text)\\n            })\\n        ]);\\n    }\\n};\\n</code></pre>\\n<blockquote>\\nSo far we have only used pure mithril to create our app - miso did do some of the grunt-work behind the scenes, but we can do much more.\\n</blockquote>\\n\\n\\n<p>Let us add some useful libraries, change the top section to:</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    sugartags = require(&#39;mithril.sugartags&#39;)(m),\\n    bindings = require(&#39;../server/mithril.bindings.node.js&#39;)(m),\\n    miso = require(&#39;../server/miso.util.js&#39;),\\n    api = require(&#39;../system/api.server.js&#39;)(m, this);\\n</code></pre>\\n<p>This will include the following libraries:</p>\\n<ul>\\n<li><a href=\\\"/doc/mithril.sugartags.md\\\">mithril.sugartags</a> - allows rendering HTML using tags that look a little more like HTML than standard mithril</li>\\n<li><a href=\\\"/doc/mithril.bindings.md\\\">mithril.bindings</a> Bi-directional data bindings for richer models</li>\\n<li>miso utilities - isomorphic abstraction for common tasks</li>\\n<li>api - the configured database adaptor</li>\\n</ul>\\n<p>Let us start with the sugar tags, update the view to read:</p>\\n<pre><code class=\\\"lang-javascript\\\">view: function(ctrl) {\\n    with(sugartags) {\\n        return UL([\\n            ctrl.list.map(function(todo){\\n                return LI(todo.text)\\n            })\\n        ])\\n    };\\n}\\n</code></pre>\\n<p>So using sugartags allows us to write more concise views, that look more like natural HTML.</p>\\n<p>Next let us update the functionality a little - add the following method to the controller:</p>\\n<pre><code class=\\\"lang-javascript\\\">this.done = function(todo){\\n    return function() {\\n        todo.done(!todo.done());\\n    }\\n};\\n</code></pre>\\n<p>This method will return a function that toggles the <code>done</code> attribute on the passed in todo. Next change the view to:</p>\\n<pre><code class=\\\"lang-javascript\\\">view: function(ctrl) {\\n    with(sugartags) {\\n        return [\\n            STYLE(&quot;.done{text-decoration: line-through;}&quot;),\\n            UL([\\n                ctrl.list.map(function(todo){\\n                    return LI({ class: todo.done()? &quot;done&quot;: &quot;&quot;, onclick: ctrl.done(todo) }, todo.text);\\n                })\\n            ])\\n        ]\\n    };\\n}\\n</code></pre>\\n<p>This will make the list of todos clickable, and put a strike-through the todo when it is set to &quot;done&quot;.</p>\\n\",\"Getting-started.md\":\"<p>This guide will take you through making your first miso app, it is assumed that you know the basics of how to use nodejs and mithril.</p>\\n<h2><a name=\\\"installation\\\" class=\\\"anchor\\\" href=\\\"#installation\\\"><span class=\\\"header-link\\\">Installation</span></a></h2><p>To install miso, use npm:</p>\\n<pre><code class=\\\"lang-javascript\\\">npm install misojs -g\\n</code></pre>\\n<p>To create and run a miso app in a new directory:</p>\\n<pre><code class=\\\"lang-javascript\\\">miso -n myapp\\ncd myapp\\nmiso run\\n</code></pre>\\n<p>You should now see something like:</p>\\n<pre><code>Miso is listening at http://localhost:6476 in development mode\\n</code></pre><p>Open your browser at <code>http://localhost:6476</code> and you will see the default miso screen</p>\\n<h2><a name=\\\"hello-world-app\\\" class=\\\"anchor\\\" href=\\\"#hello-world-app\\\"><span class=\\\"header-link\\\">Hello world app</span></a></h2><p>Create a new file <code>hello.js</code> in <code>myapp/mvc</code> like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    miso = require(&#39;../server/miso.util.js&#39;),\\n    sugartags = require(&#39;mithril.sugartags&#39;)(m);\\n\\nvar edit = module.exports.edit = {\\n    models: {\\n        hello: function(data){\\n            this.who = m.prop(data.who);\\n        }\\n    },\\n    controller: function(params) {\\n        var who = miso.getParam(&#39;hello_id&#39;, params);\\n        this.model = new edit.models.hello({who: who});\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        with(sugartags) {\\n            return DIV(&quot;Hello &quot; + ctrl.model.who());\\n        }\\n    }\\n};\\n</code></pre>\\n<p>Then open <a href=\\\"/doc/YOURNAME.md\\\">http://localhost:6476/hello/YOURNAME</a> and you should see &quot;Hello YOURNAME&quot;. Change the url to have your actual name instead of YOURNAME, you now know miso :)</p>\\n<p>Let us take a look at what each piece of the code is actually doing:</p>\\n<h3><a name=\\\"includes\\\" class=\\\"anchor\\\" href=\\\"#includes\\\"><span class=\\\"header-link\\\">Includes</span></a></h3><blockquote>\\nSummary: Mithril is the only required library when apps, but using other included libraries is very useful\\n</blockquote>\\n\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    miso = require(&#39;../server/miso.util.js&#39;),\\n    sugartags = require(&#39;mithril.sugartags&#39;)(m);\\n</code></pre>\\n<p>Here we grab mithril, then miso utilities and sugar tags - technically speaking, we really only need mithril, but the other libraries are very useful as well as we will see.</p>\\n<h3><a name=\\\"models\\\" class=\\\"anchor\\\" href=\\\"#models\\\"><span class=\\\"header-link\\\">Models</span></a></h3><blockquote>\\nSummary: Use the automatic routing when you can, always put models on the &#39;models&#39; attribute of your mvc file\\n</blockquote>\\n\\n<pre><code class=\\\"lang-javascript\\\">var edit = module.exports.edit = {\\n    models: {\\n        hello: function(data){\\n            this.who = m.prop(data.who);\\n        }\\n    },\\n</code></pre>\\n<p>Here a few important things are going on:</p>\\n<ul>\\n<li><p>By placing our <code>mvc</code> object on <code>module.exports.edit</code>, automatic routing is applied by miso - you can read more about <a href=\\\"/doc/How-miso-works#route-by-convention.md\\\">how the automatic routing works here</a>. </p>\\n</li>\\n<li><p>Placing our <code>hello</code> model on the <code>models</code> attribute of the object ensures that miso can figure out what your models are, and will create a persistence API automatically for you when the server starts up, so that you can save your models into the database.</p>\\n</li>\\n</ul>\\n<h3><a name=\\\"controller\\\" class=\\\"anchor\\\" href=\\\"#controller\\\"><span class=\\\"header-link\\\">Controller</span></a></h3><blockquote>\\nSummary: DO NOT forget to &#39;return this;&#39; in the controller, it is vital!\\n</blockquote>\\n\\n<pre><code class=\\\"lang-javascript\\\">controller: function(params) {\\n    var who = miso.getParam(&#39;hello_id&#39;, params);\\n    this.model = new edit.models.hello({who: who});\\n    return this;\\n},\\n</code></pre>\\n<p>The controller uses <code>miso.getParam</code> to retreive the parameter - this is so that it can work seamlessly on both the server and client side. We create a new model, and very importantly <code>return this</code> ensures that miso can get access to the controller correctly.</p>\\n<h3><a name=\\\"view\\\" class=\\\"anchor\\\" href=\\\"#view\\\"><span class=\\\"header-link\\\">View</span></a></h3><blockquote>\\nSummary: Use sugartags to make the view look more like HTML\\n</blockquote>\\n\\n<pre><code class=\\\"lang-javascript\\\">view: function(ctrl) {\\n    with(sugartags) {\\n        return DIV(&quot;Hello &quot; + ctrl.model.who());\\n    }\\n}\\n</code></pre>\\n<p>The view is simply a javascript function that returns a structure. Here we use the <code>sugartags</code> library to render the DIV tag - this is strictly not required, but I find that people tend to understand the sugartags syntax better than pure mithril, as it looks a little more like HTML, though of course you could use standard mithril syntax if you prefer.</p>\\n<h3><a name=\\\"next\\\" class=\\\"anchor\\\" href=\\\"#next\\\"><span class=\\\"header-link\\\">Next</span></a></h3><p>You now have a complete hello world app, and understand the fundamentals of the structure of a miso mvc application.</p>\\n<p>We have only just scraped the surface of what miso is capable of, so next we recommend you read:</p>\\n<p><a href=\\\"/doc/Creating-a-todo-app.md\\\">Creating a todo app</a></p>\\n\",\"Goals.md\":\"<h1><a name=\\\"primary-goals\\\" class=\\\"anchor\\\" href=\\\"#primary-goals\\\"><span class=\\\"header-link\\\">Primary goals</span></a></h1><ul>\\n<li>Easy setup of <a href=\\\"/doc/.md\\\">isomorphic</a> application based on <a href=\\\"/doc/mithril.js.md\\\">mithril</a></li>\\n<li>Skeleton / scaffold / Boilerplate to allow users to very quickly get up and running.</li>\\n<li>minimal core</li>\\n<li>easy extendible</li>\\n<li>DB agnostic (e. G. plugins for different ORM/ODM)</li>\\n</ul>\\n<h1><a name=\\\"components\\\" class=\\\"anchor\\\" href=\\\"#components\\\"><span class=\\\"header-link\\\">Components</span></a></h1><ul>\\n<li>Routing</li>\\n<li>View rendering</li>\\n<li>i18n/l10n</li>\\n<li>Rest-API (could use restify: <a href=\\\"/doc/.md\\\">http://mcavage.me/node-restify/</a>)</li>\\n<li>optional Websockets (could use restify: <a href=\\\"/doc/.md\\\">http://mcavage.me/node-restify/</a>)</li>\\n<li>easy testing (headless and Browser-Tests)</li>\\n<li>login/session handling</li>\\n<li>models with validation</li>\\n</ul>\\n<h1><a name=\\\"useful-libs\\\" class=\\\"anchor\\\" href=\\\"#useful-libs\\\"><span class=\\\"header-link\\\">Useful libs</span></a></h1><p>Here are some libraries we are considering using, (in no particular order):</p>\\n<ul>\\n<li>leveldb</li>\\n<li>mithril-query</li>\\n<li>translate.js</li>\\n<li>i18next</li>\\n</ul>\\n<p>And some that we&#39;re already using:</p>\\n<ul>\\n<li>express</li>\\n<li>browserify</li>\\n<li>mocha/expect</li>\\n<li>mithril-node-render</li>\\n<li>mithril-sugartags</li>\\n<li>mithril-bindings</li>\\n<li>mithril-animate</li>\\n<li>lodash</li>\\n<li>validator</li>\\n</ul>\\n\",\"Home.md\":\"<p>Welcome to the misojs wiki!</p>\\n<h1><a name=\\\"getting-started\\\" class=\\\"anchor\\\" href=\\\"#getting-started\\\"><span class=\\\"header-link\\\">Getting started</span></a></h1><p>See the <a href=\\\"/doc/misojs#install.md\\\">install guide</a>.\\nRead <a href=\\\"/doc/How-miso-works.md\\\">how miso works</a>, and check out <a href=\\\"/doc/Patterns.md\\\">the patterns</a>, then create something cool!</p>\\n\",\"How-miso-works.md\":\"<h2><a name=\\\"models-views-controllers\\\" class=\\\"anchor\\\" href=\\\"#models-views-controllers\\\"><span class=\\\"header-link\\\">Models, views, controllers</span></a></h2><p>When creating a route, you must assign a controller and a view to it - this is achieved by creating a file in the <code>/mvc</code> directory - by convention, you should name it as per the path you want, (see the <a href=\\\"/doc/#routing.md\\\">routing section</a> for details).</p>\\n<p>Here is a minimal example using the sugartags, and getting a parameter:</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    miso = require(&#39;../server/miso.util.js&#39;),\\n    sugartags = require(&#39;../server/mithril.sugartags.node.js&#39;)(m);\\n\\nmodule.exports.index = {\\n    controller: function(params) {\\n        this.who = miso.getParam(&#39;who&#39;, params, &#39;world&#39;);\\n        return this;\\n    },\\n    view: function(ctrl){\\n        with(sugartags) {\\n            return DIV(&#39;Hello &#39; + ctrl.who);\\n        }\\n    }\\n};\\n</code></pre>\\n<p>Save this into a file <code>/mvc/hello.js</code>, and open <a href=\\\"/doc/hellos.md\\\">http://localhost/hellos</a>, this will show &quot;Hello world&quot;. Note the &#39;s&#39; on the end - this is due to how the <a href=\\\"/doc/#route-by-convention.md\\\">route by convention</a> works.</p>\\n<p>Now open <code>/cfg/routes.json</code>, and add the following routes:</p>\\n<pre><code class=\\\"lang-javascript\\\">    &quot;/hello&quot;: { &quot;method&quot;: &quot;get&quot;, &quot;name&quot;: &quot;hello&quot;, &quot;action&quot;: &quot;index&quot; },\\n    &quot;/hello/:who&quot;: { &quot;method&quot;: &quot;get&quot;, &quot;name&quot;: &quot;hello&quot;, &quot;action&quot;: &quot;index&quot; }\\n</code></pre>\\n<p>Save the file, and go back to the browser, and you&#39;ll see an error! This is because we have now overridden the automatic route. Open <a href=\\\"/doc/hello.md\\\">http://localhost/hello</a>, and you&#39;ll see our action. Now open <a href=\\\"/doc/YOURNAME.md\\\">http://localhost/hello/YOURNAME</a>, and you&#39;ll see it getting the first parameter, and greeting you!</p>\\n<h2><a name=\\\"routing\\\" class=\\\"anchor\\\" href=\\\"#routing\\\"><span class=\\\"header-link\\\">Routing</span></a></h2><p>The routing can be defined in one of two ways</p>\\n<h3><a name=\\\"route-by-convention\\\" class=\\\"anchor\\\" href=\\\"#route-by-convention\\\"><span class=\\\"header-link\\\">Route by convention</span></a></h3><p>You can use a naming convention as follows:</p>\\n<table>\\n<thead>\\n<tr>\\n<th>Action</th>\\n<th>Method</th>\\n<th>URL</th>\\n<th>Description</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>index</td>\\n<td>GET</td>\\n<td>[controller] + &#39;s&#39;</td>\\n<td>List the items</td>\\n</tr>\\n<tr>\\n<td>edit</td>\\n<td>GET</td>\\n<td>[controller]/[id]</td>\\n<td>Display a form to edit the item</td>\\n</tr>\\n<tr>\\n<td>new</td>\\n<td>GET</td>\\n<td>[controller] + &#39;s&#39; + &#39;/new&#39;</td>\\n<td>Display a form to add a new item</td>\\n</tr>\\n</tbody>\\n</table>\\n<p>Say you have a mvc file named &quot;user.js&quot;, and you define an action like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">module.exports.index = {...\\n</code></pre>\\n<p>Miso will automatically map a &quot;GET&quot; to &quot;/users&quot;.<br>Now say you have a mvc file named &quot;user.js&quot;, and you define an action like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">module.exports.edit = {...\\n</code></pre>\\n<p>Miso will automatically map a &quot;GET&quot; to &quot;/user/:user_id&quot;, so that users can access via a route such as &quot;/user/27&quot; for use with ID of 27. <em>Note:</em> You can get the user_id using a miso utility: <code>var userId = miso.getParam(&#39;user_id&#39;, params);</code>.</p>\\n<h3><a name=\\\"route-by-configuration\\\" class=\\\"anchor\\\" href=\\\"#route-by-configuration\\\"><span class=\\\"header-link\\\">Route by configuration</span></a></h3><p>By using <code>/cfg/routes.json</code> config file:</p>\\n<pre><code class=\\\"lang-javascript\\\">{\\n    &quot;[Pattern]&quot;: { &quot;method&quot;: &quot;[Method]&quot;, &quot;name&quot;: &quot;[Route name]&quot;, &quot;action&quot;: &quot;[Action]&quot; }\\n}\\n</code></pre>\\n<p>Where:</p>\\n<ul>\\n<li><strong>Pattern</strong> - the <a href=\\\"/doc/#routing-patterns.md\\\">route pattern</a> we want, including any parameters</li>\\n<li><strong>Method</strong> - one of &#39;GET&#39;, &#39;POST&#39;, &#39;PUT&#39;, &#39;DELETE&#39;</li>\\n<li><strong>Route</strong> name - name of your route file from /mvc</li>\\n<li><strong>Action</strong> - name of the action to call on your route file from /mvc</li>\\n</ul>\\n<p><strong>Example</strong></p>\\n<pre><code class=\\\"lang-javascript\\\">{\\n    &quot;/&quot;: { &quot;method&quot;: &quot;get&quot;, &quot;name&quot;: &quot;home&quot;, &quot;action&quot;: &quot;index&quot; }\\n}\\n</code></pre>\\n<p>This will map a &quot;GET&quot; to the root of the URL for the <code>index</code> action in <code>home.js</code></p>\\n<p><strong>Note:</strong> The routing config will override any automatically defined routes, so if you need multiple routes to point to the same action, you must manually define them. For example, if you have a mvc file named &quot;term.js&quot;, and you define an action like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">module.exports.index = {...\\n</code></pre>\\n<p>Miso will automatically map a &quot;GET&quot; to &quot;/terms&quot;. Now, if you want to map it also to &quot;/AGB&quot;, you will need to add two entries in the routes config:</p>\\n<pre><code class=\\\"lang-javascript\\\">{\\n    &quot;/terms&quot;: { &quot;method&quot;: &quot;get&quot;, &quot;name&quot;: &quot;terms&quot;, &quot;action&quot;: &quot;index&quot; },\\n    &quot;/AGB&quot;: { &quot;method&quot;: &quot;get&quot;, &quot;name&quot;: &quot;terms&quot;, &quot;action&quot;: &quot;index&quot; }\\n}\\n</code></pre>\\n<p>This is because Miso assumes that if you override the defaulted routes, you actually want to replace them, not just override them. <em>Note:</em> this is correct behaviour, as it minority case is when you want more than one route pointing to the same action.</p>\\n<h3><a name=\\\"routing-patterns\\\" class=\\\"anchor\\\" href=\\\"#routing-patterns\\\"><span class=\\\"header-link\\\">Routing patterns</span></a></h3><table>\\n<thead>\\n<tr>\\n<th>Type</th>\\n<th>Example</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>Path</td>\\n<td>&quot;/abcd&quot; - match paths starting with /abcd</td>\\n</tr>\\n<tr>\\n<td>Path Pattern</td>\\n<td>&quot;/abc?d&quot; - match paths starting with /abcd and /abd</td>\\n</tr>\\n<tr>\\n<td>Path Pattern</td>\\n<td>&quot;/ab+cd&quot; - match paths starting with /abcd, /abbcd, /abbbbbcd and so on</td>\\n</tr>\\n<tr>\\n<td>Path Pattern</td>\\n<td>&quot;/ab*cd&quot; - match paths starting with /abcd, /abxcd, /abFOOcd, /abbArcd and so on</td>\\n</tr>\\n<tr>\\n<td>Path Pattern</td>\\n<td>&quot;/a(bc)?d&quot; - will match paths starting with /ad and /abcd</td>\\n</tr>\\n<tr>\\n<td>Regular Expression</td>\\n<td>/\\\\/abc&#124;\\\\/xyz/ - will match paths starting with /abc and /xyz</td>\\n</tr>\\n<tr>\\n<td>Array</td>\\n<td>[&quot;/abcd&quot;, &quot;/xyza&quot;, /\\\\/lmn&#124;\\\\/pqr/] - match paths starting with /abcd, /xyza, /lmn, and /pqr</td>\\n</tr>\\n</tbody>\\n</table>\\n<h3><a name=\\\"links\\\" class=\\\"anchor\\\" href=\\\"#links\\\"><span class=\\\"header-link\\\">Links</span></a></h3><p>When you create links, in order to get the app to work as an SPA, you must pass in m.route as a config, so that the history will be updated correctly, for example:</p>\\n<pre><code class=\\\"lang-javascript\\\">A({href:&quot;/users/new&quot;, config: m.route}, &quot;Add new user&quot;)\\n</code></pre>\\n<p>This will correctly work as a SPA. If you leave out <code>config: m.route</code>, the app will still work, but the page will reload every time the link is followed.</p>\\n<ul>\\n<li>Lightweight footprint</li>\\n<li>Full-stack isomorphic framework</li>\\n<li>SPA that renders the initial page server side</li>\\n<li>Data models with isomorphic validation</li>\\n<li>Auto-reload browser on changes</li>\\n</ul>\\n<h2><a name=\\\"data-models\\\" class=\\\"anchor\\\" href=\\\"#data-models\\\"><span class=\\\"header-link\\\">Data models</span></a></h2><p>Data models are progressively enhanced mithril models - you simply create your model as usual, then add validation and type information as it becomes pertinent.\\nFor example, say you have a model like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">var userModel = function(data){\\n    this.name = m.p(data.name||&quot;&quot;);\\n    this.email = m.p(data.email||&quot;&quot;);\\n    this.id = m.p(data._id||&quot;&quot;);\\n    return this;\\n}\\n</code></pre>\\n<p>In order to make it validatable, add the validator module:</p>\\n<pre><code class=\\\"lang-javascript\\\">var validate = require(&#39;validator.modelbinder&#39;);\\n</code></pre>\\n<p>Then add a <code>isValid</code> validation method to your model, with any declarations based on <a href=\\\"/doc/validator.js#validators.md\\\">node validator</a>:</p>\\n<pre><code class=\\\"lang-javascript\\\">var userModel = function(data){\\n    this.name = m.p(data.name||&quot;&quot;);\\n    this.email = m.p(data.email||&quot;&quot;);\\n    this.id = m.p(data._id||&quot;&quot;);\\n\\n    //    Validate the model        \\n    this.isValid = validate.bind(this, {\\n        name: {\\n            isRequired: &quot;You must enter a name&quot;\\n        },\\n        email: {\\n            isRequired: &quot;You must enter an email address&quot;,\\n            isEmail: &quot;Must be a valid email address&quot;\\n        }\\n    });\\n\\n    return this;\\n};\\n</code></pre>\\n<p>This creates a method that the miso database adaptor can use to validate your model.\\nYou get full access to the validation info as well, so you can show an error message near your field, for example:</p>\\n<pre><code class=\\\"lang-javascript\\\">user.isValid(&#39;email&#39;)\\n</code></pre>\\n<p>Will return <code>true</code> if the <code>email</code> property of your user model is valid, or a list of errors messages if it is invalid:</p>\\n<pre><code class=\\\"lang-javascript\\\">[&quot;You must enter an email address&quot;, &quot;Must be a valid email address&quot;]\\n</code></pre>\\n<p>So you can for example add a class name to a div surrounding your field like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">DIV({class: (ctrl.user.isValid(&#39;email&#39;) == true? &quot;valid&quot;: &quot;invalid&quot;)}, [...\\n</code></pre>\\n<p>And show the error messages like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">SPAN(ctrl.user.isValid(&#39;email&#39;) == true? &quot;&quot;: ctrl.user.isValid(&#39;email&#39;).join(&quot;, &quot;))\\n</code></pre>\\n<h2><a name=\\\"database-adaptor-api-and-model-interaction\\\" class=\\\"anchor\\\" href=\\\"#database-adaptor-api-and-model-interaction\\\"><span class=\\\"header-link\\\">Database adaptor, api and model interaction</span></a></h2><p>Miso uses the model definitions that you declare in your <code>mvc</code> file to build up a set of models that the API can use, the model definitions work like this:</p>\\n<ul>\\n<li>On the models attribute of the mvc, we  define a standard mithril data model, (ie: a javascript object where properties can be either standard javascript data types, or a function that works as a getter/setter, eg: <code>m.prop</code>)</li>\\n<li>On server startup, miso reads this and creates a cache of the model objects, including the name space of the model, eg: &quot;hello.edit.hello&quot;</li>\\n<li>Models can optionally include data validation information, and the database adaptor will get access to this.</li>\\n</ul>\\n<p>Assuming we have a model in the hello.models object like so:</p>\\n<pre><code class=\\\"lang-javascript\\\">hello: function(data){\\n    this.who = m.prop(data.who);\\n    this.isValid = validate.bind(this, {\\n        who: {\\n            isRequired: &quot;You must know who you are talking to&quot;\\n        }\\n    });\\n}\\n</code></pre>\\n<p>The API works like this:</p>\\n<ul>\\n<li>We create an endpoint at <code>/api</code> where each we load whatever adaptor is configured in <code>/cfg/server.json</code>, and expose each method. For example <code>/api/save</code> is available for the default <code>flatfiledb</code> adaptor.</li>\\n<li>Next we create a set of API files - one for client, (/system/api.client.js), and one for server (/system/api.server.js) - each have the same methods, but do vastly different things:<ul>\\n<li>api.client.js is a thin wrapper that uses mithril&#39;s m.request to create an ajax request to the server API, it simply passes messages back and forth (in JSON RPC 2.0 format).</li>\\n<li>api.server.js calls the database adaptor methods, which in turn handles models and validation so for example when a request is made and a <code>type</code> and <code>model</code> is included, we can re-construct the data model based on this info, for example you might send: {type: &#39;hello.edit.hello&#39;, model: {who: &#39;Dave&#39;}}, this can then be cast back into a model that we can call the <code>isValid</code> method on.</li>\\n</ul>\\n</li>\\n</ul>\\n<p><strong>Now, the important bit:</strong> The reason for all this functionality is that mithril internally delays rendering to the DOM whilst a request is going on, so we need to handle this within miso - in order to be able to render things on the server - so we have a binding system that delays rendering whilst an async request is still being executed. That means mithril-like code like this:</p>\\n<pre><code class=\\\"lang-javascript\\\">controller: function(){\\n    var ctrl = this;\\n    api.find({type: &#39;hello.index.hello&#39;}).then(function(data) {\\n        var list = Object.keys(data.result).map(function(key) {\\n            var myHello = data.result[key];\\n            return new self.models.hello(myHello);\\n        });\\n        ctrl.model = new ctrl.vm.todoList(list);\\n    });\\n    return ctrl;\\n}\\n</code></pre>\\n<p>Will still work. Note: the magic here is that there is absolutely nothing in the code above that runs a callback to let mithril know the data is ready - this is a design feature of mithril to delay rendering automatically whilst an <code>m.request</code> is in progress, so we cater for this to have the ability to render the page server-side first, so that SEO works out of the box.</p>\\n<h2><a name=\\\"client-vs-server-code\\\" class=\\\"anchor\\\" href=\\\"#client-vs-server-code\\\"><span class=\\\"header-link\\\">Client vs server code</span></a></h2><p>In miso, you include files using the standard nodejs <code>require</code> function. When you need to do something that works differently in the browser than the server, there are a few ways you can achieve it:</p>\\n<ul>\\n<li>The recommended way is to create and require a file in the <code>server/</code> directory, and then create the same file in the <code>client/</code> directory, and miso will automatically load that file for you on the client side.</li>\\n<li>If this is not to your liking, another option is to use <code>miso.util</code> - you can use <code>miso.util.isServer()</code> to test if you&#39;re on the server or not, though it is better practice to use the server/client directory method.</li>\\n</ul>\\n<h2><a name=\\\"requiring-files\\\" class=\\\"anchor\\\" href=\\\"#requiring-files\\\"><span class=\\\"header-link\\\">Requiring files</span></a></h2><p>When requiring files, be sure to do so in a static manner so that browserify is able to compile the client side script. Always use:</p>\\n<pre><code class=\\\"lang-javascript\\\">var miso = require(&#39;../server/miso.util.js&#39;);\\n</code></pre>\\n<p>NEVER DO ANY OF THESE:</p>\\n<pre><code class=\\\"lang-javascript\\\">//  DON&#39;T DO THIS!\\nvar miso = new require(&#39;../server/miso.util.js&#39;);\\n</code></pre>\\n<p>This will create an object, which means <a href=\\\"/doc/824.md\\\">browserify cannot resolve it statically</a>, and will ignore it.</p>\\n<pre><code class=\\\"lang-javascript\\\">//  DON&#39;T DO THIS!\\nvar thing = &#39;miso&#39;;\\nvar miso = require(&#39;../server/&#39;+thing+&#39;.util.js&#39;);\\n</code></pre>\\n<p>This will create an expression, which means <a href=\\\"/doc/824.md\\\">browserify cannot resolve it statically</a>, and will ignore it.</p>\\n\",\"Patterns.md\":\"<p>There are several ways you can write your app and miso is not opinionated about how you go about this so it is important that you choose a pattern that suits your needs. Below are a few suggested patterns to follow when developing apps.</p>\\n<p><strong>Note:</strong> miso is a single page app that loads server rendered HTML from any URL, so that SEO works out of the box.</p>\\n<h2><a name=\\\"single-url-mvc\\\" class=\\\"anchor\\\" href=\\\"#single-url-mvc\\\"><span class=\\\"header-link\\\">Single url mvc</span></a></h2><p>In this pattern everything that your mvc needs to do is done on a single url for all the associated actions. The advantage for this style of development is that you have everything in one mvc container, and you don&#39;t need to map any routes - of course the downside being that there are no routes for the user to bookmark. This is pattern works well for smaller entities where there are not too many interactions that the user can do - this is essentially how most mithril apps are written - self-contained, and at a single url.</p>\\n<p>Here is a &quot;hello world&quot; example using the single url pattern</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    sugartags = require(&#39;../server/mithril.sugartags.node.js&#39;)(m);\\n\\nvar self = module.exports.index = {\\n    models: {\\n        //    Our model\\n        hello: function(data){\\n            this.who = m.p(data.who);\\n        }\\n    },\\n    controller: function(params) {\\n        this.model = new self.models.hello({who: &quot;world&quot;});\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        var model = ctrl.model;\\n        with(sugartags) {\\n            return [\\n                DIV(&quot;Hello &quot; + model.who())\\n            ];\\n        }\\n    }\\n};\\n</code></pre>\\n<p>This would expose a url /hellos (note: the &#39;s&#39;), and would display &quot;Hello world&quot;. (You can change the route using custom routing)</p>\\n<h2><a name=\\\"multi-url-mvc\\\" class=\\\"anchor\\\" href=\\\"#multi-url-mvc\\\"><span class=\\\"header-link\\\">Multi url mvc</span></a></h2><p>In this pattern we expose multiple mvc routes that in turn translate to multiple URLs. This is useful for splitting up your app, and ensuring each mvc has its own sets of concerns.</p>\\n<pre><code class=\\\"lang-javascript\\\">var m = require(&#39;mithril&#39;),\\n    miso = require(&#39;../server/miso.util.js&#39;),\\n    sugartags = require(&#39;../server/mithril.sugartags.node.js&#39;)(m);\\n\\nvar index = module.exports.index = {\\n    models: {\\n        //    Our model\\n        hello: function(data){\\n            this.who = m.p(data.who);\\n        }\\n    },\\n    controller: function(params) {\\n        this.model = new index.models.hello({who: &quot;world&quot;});\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        var model = ctrl.model;\\n        with(sugartags) {\\n            return [\\n                DIV(&quot;Hello &quot; + model.who()),\\n                A({href: &quot;/hello/Leo&quot;, config: m.route}, &quot;Click me for the edit action&quot;)\\n            ];\\n        }\\n    }\\n};\\n\\nvar edit = module.exports.edit = {\\n    controller: function(params) {\\n        var who = miso.getParam(&#39;hello_id&#39;, params);\\n        this.model = new index.models.hello({who: who});\\n        return this;\\n    },\\n    view: function(ctrl) {\\n        var model = ctrl.model;\\n        with(sugartags) {\\n            return [\\n                DIV(&quot;Hello &quot; + model.who())\\n            ];\\n        }\\n    }\\n};\\n</code></pre>\\n<p>Here we also expose a &quot;/hello/[NAME]&quot; url, that will show your name when you visit /hello/[YOUR NAME], so there are now multiple urls for our SPA:</p>\\n<ul>\\n<li><strong>/hellos</strong> - this is intended to be an index page that lists all your &quot;hellos&quot;</li>\\n<li><strong>/hello/[NAME]</strong> - this is intended to be an edit page where you can edit your &quot;hellos&quot;</li>\\n</ul>\\n<p>Note that the anchor tag has <code>config: m.route</code> in it&#39;s options - this is so that we can route automatically though mithril</p>\\n\"}; };","/* NOTE: This is a generated file, please do not modify it, your changes will be lost */\nmodule.exports = function(m){\n\tvar getModelData = function(model){\n\t\tvar i, result = {};\n\t\tfor(i in model) {if(model.hasOwnProperty(i)) {\n\t\t\tif(i !== 'isValid') {\n\t\t\t\tif(i == 'id') {\n\t\t\t\t\tresult['_id'] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t} else {\n\t\t\t\t\tresult[i] = (typeof model[i] == 'function')? model[i](): model[i];\n\t\t\t\t}\n\t\t\t}\n\t\t}}\n\t\treturn result;\n\t};\n\treturn {\n'photos': function(args, options){\n\toptions = options || {};\n\tvar requestObj = {\n\t\t\tmethod:'post', \n\t\t\turl: '/api/flickr/photos',\n\t\t\tdata: args\n\t\t},\n\t\trootNode = document.documentElement || document.body;\n\tfor(var i in options) {if(options.hasOwnProperty(i)){\n\t\trequestObj[i] = options[i];\n\t}}\n\tif(args.model) {\n \t\targs.model = getModelData(args.model);\n\t}\n\trootNode.className += ' loading';\n\tvar myDeferred = m.deferred();\n\tm.request(requestObj).then(function(){\n\t\trootNode.className = rootNode.className.split(' loading').join('');\n\t\tmyDeferred.resolve.apply(this, arguments);\n\t\tif(requestObj.background){\n\t\t\tm.redraw(true);\n\t\t}\n\t});\n\treturn myDeferred.promise;\n}\n\t};\n};","var m = (function app(window, undefined) {\r\n\tvar OBJECT = \"[object Object]\", ARRAY = \"[object Array]\", STRING = \"[object String]\", FUNCTION = \"function\";\r\n\tvar type = {}.toString;\r\n\tvar parser = /(?:(^|#|\\.)([^#\\.\\[\\]]+))|(\\[.+?\\])/g, attrParser = /\\[(.+?)(?:=(\"|'|)(.*?)\\2)?\\]/;\r\n\tvar voidElements = /^(AREA|BASE|BR|COL|COMMAND|EMBED|HR|IMG|INPUT|KEYGEN|LINK|META|PARAM|SOURCE|TRACK|WBR)$/;\r\n\r\n\t// caching commonly used variables\r\n\tvar $document, $location, $requestAnimationFrame, $cancelAnimationFrame;\r\n\r\n\t// self invoking function needed because of the way mocks work\r\n\tfunction initialize(window){\r\n\t\t$document = window.document;\r\n\t\t$location = window.location;\r\n\t\t$cancelAnimationFrame = window.cancelAnimationFrame || window.clearTimeout;\r\n\t\t$requestAnimationFrame = window.requestAnimationFrame || window.setTimeout;\r\n\t}\r\n\r\n\tinitialize(window);\r\n\r\n\r\n\t/**\r\n\t * @typedef {String} Tag\r\n\t * A string that looks like -> div.classname#id[param=one][param2=two]\r\n\t * Which describes a DOM node\r\n\t */\r\n\r\n\t/**\r\n\t *\r\n\t * @param {Tag} The DOM node tag\r\n\t * @param {Object=[]} optional key-value pairs to be mapped to DOM attrs\r\n\t * @param {...mNode=[]} Zero or more Mithril child nodes. Can be an array, or splat (optional)\r\n\t *\r\n\t */\r\n\tfunction m() {\r\n\t\tvar args = [].slice.call(arguments);\r\n\t\tvar hasAttrs = args[1] != null && type.call(args[1]) === OBJECT && !(\"tag\" in args[1]) && !(\"subtree\" in args[1]);\r\n\t\tvar attrs = hasAttrs ? args[1] : {};\r\n\t\tvar classAttrName = \"class\" in attrs ? \"class\" : \"className\";\r\n\t\tvar cell = {tag: \"div\", attrs: {}};\r\n\t\tvar match, classes = [];\r\n\t\tif (type.call(args[0]) != STRING) throw new Error(\"selector in m(selector, attrs, children) should be a string\")\r\n\t\twhile (match = parser.exec(args[0])) {\r\n\t\t\tif (match[1] === \"\" && match[2]) cell.tag = match[2];\r\n\t\t\telse if (match[1] === \"#\") cell.attrs.id = match[2];\r\n\t\t\telse if (match[1] === \".\") classes.push(match[2]);\r\n\t\t\telse if (match[3][0] === \"[\") {\r\n\t\t\t\tvar pair = attrParser.exec(match[3]);\r\n\t\t\t\tcell.attrs[pair[1]] = pair[3] || (pair[2] ? \"\" :true)\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (classes.length > 0) cell.attrs[classAttrName] = classes.join(\" \");\r\n\r\n\r\n\t\tvar children = hasAttrs ? args[2] : args[1];\r\n\t\tif (type.call(children) === ARRAY) {\r\n\t\t\tcell.children = children\r\n\t\t}\r\n\t\telse {\r\n\t\t\tcell.children = hasAttrs ? args.slice(2) : args.slice(1)\r\n\t\t}\r\n\r\n\t\tfor (var attrName in attrs) {\r\n\t\t\tif (attrName === classAttrName) {\r\n\t\t\t\tif (attrs[attrName] !== \"\") cell.attrs[attrName] = (cell.attrs[attrName] || \"\") + \" \" + attrs[attrName];\r\n\t\t\t}\r\n\t\t\telse cell.attrs[attrName] = attrs[attrName]\r\n\t\t}\r\n\t\treturn cell\r\n\t}\r\n\tfunction build(parentElement, parentTag, parentCache, parentIndex, data, cached, shouldReattach, index, editable, namespace, configs) {\r\n\t\t//`build` is a recursive function that manages creation/diffing/removal of DOM elements based on comparison between `data` and `cached`\r\n\t\t//the diff algorithm can be summarized as this:\r\n\t\t//1 - compare `data` and `cached`\r\n\t\t//2 - if they are different, copy `data` to `cached` and update the DOM based on what the difference is\r\n\t\t//3 - recursively apply this algorithm for every array and for the children of every virtual element\r\n\r\n\t\t//the `cached` data structure is essentially the same as the previous redraw's `data` data structure, with a few additions:\r\n\t\t//- `cached` always has a property called `nodes`, which is a list of DOM elements that correspond to the data represented by the respective virtual element\r\n\t\t//- in order to support attaching `nodes` as a property of `cached`, `cached` is *always* a non-primitive object, i.e. if the data was a string, then cached is a String instance. If data was `null` or `undefined`, cached is `new String(\"\")`\r\n\t\t//- `cached also has a `configContext` property, which is the state storage object exposed by config(element, isInitialized, context)\r\n\t\t//- when `cached` is an Object, it represents a virtual element; when it's an Array, it represents a list of elements; when it's a String, Number or Boolean, it represents a text node\r\n\r\n\t\t//`parentElement` is a DOM element used for W3C DOM API calls\r\n\t\t//`parentTag` is only used for handling a corner case for textarea values\r\n\t\t//`parentCache` is used to remove nodes in some multi-node cases\r\n\t\t//`parentIndex` and `index` are used to figure out the offset of nodes. They're artifacts from before arrays started being flattened and are likely refactorable\r\n\t\t//`data` and `cached` are, respectively, the new and old nodes being diffed\r\n\t\t//`shouldReattach` is a flag indicating whether a parent node was recreated (if so, and if this node is reused, then this node must reattach itself to the new parent)\r\n\t\t//`editable` is a flag that indicates whether an ancestor is contenteditable\r\n\t\t//`namespace` indicates the closest HTML namespace as it cascades down from an ancestor\r\n\t\t//`configs` is a list of config functions to run after the topmost `build` call finishes running\r\n\r\n\t\t//there's logic that relies on the assumption that null and undefined data are equivalent to empty strings\r\n\t\t//- this prevents lifecycle surprises from procedural helpers that mix implicit and explicit return statements (e.g. function foo() {if (cond) return m(\"div\")}\r\n\t\t//- it simplifies diffing code\r\n\t\t//data.toString() is null if data is the return value of Console.log in Firefox\r\n\t\tif (data == null || data.toString() == null) data = \"\";\r\n\t\tif (data.subtree === \"retain\") return cached;\r\n\t\tvar cachedType = type.call(cached), dataType = type.call(data);\r\n\t\tif (cached == null || cachedType !== dataType) {\r\n\t\t\tif (cached != null) {\r\n\t\t\t\tif (parentCache && parentCache.nodes) {\r\n\t\t\t\t\tvar offset = index - parentIndex;\r\n\t\t\t\t\tvar end = offset + (dataType === ARRAY ? data : cached.nodes).length;\r\n\t\t\t\t\tclear(parentCache.nodes.slice(offset, end), parentCache.slice(offset, end))\r\n\t\t\t\t}\r\n\t\t\t\telse if (cached.nodes) clear(cached.nodes, cached)\r\n\t\t\t}\r\n\t\t\tcached = new data.constructor;\r\n\t\t\tif (cached.tag) cached = {}; //if constructor creates a virtual dom element, use a blank object as the base cached node instead of copying the virtual el (#277)\r\n\t\t\tcached.nodes = []\r\n\t\t}\r\n\r\n\t\tif (dataType === ARRAY) {\r\n\t\t\t//recursively flatten array\r\n\t\t\tfor (var i = 0, len = data.length; i < len; i++) {\r\n\t\t\t\tif (type.call(data[i]) === ARRAY) {\r\n\t\t\t\t\tdata = data.concat.apply([], data);\r\n\t\t\t\t\ti-- //check current index again and flatten until there are no more nested arrays at that index\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvar nodes = [], intact = cached.length === data.length, subArrayCount = 0;\r\n\r\n\t\t\t//keys algorithm: sort elements without recreating them if keys are present\r\n\t\t\t//1) create a map of all existing keys, and mark all for deletion\r\n\t\t\t//2) add new keys to map and mark them for addition\r\n\t\t\t//3) if key exists in new list, change action from deletion to a move\r\n\t\t\t//4) for each key, handle its corresponding action as marked in previous steps\r\n\t\t\t//5) copy unkeyed items into their respective gaps\r\n\t\t\tvar DELETION = 1, INSERTION = 2 , MOVE = 3;\r\n\t\t\tvar existing = {}, unkeyed = [], shouldMaintainIdentities = false;\r\n\t\t\tfor (var i = 0; i < cached.length; i++) {\r\n\t\t\t\tif (cached[i] && cached[i].attrs && cached[i].attrs.key != null) {\r\n\t\t\t\t\tshouldMaintainIdentities = true;\r\n\t\t\t\t\texisting[cached[i].attrs.key] = {action: DELETION, index: i}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (shouldMaintainIdentities) {\r\n\t\t\t\tif (data.indexOf(null) > -1) data = data.filter(function(x) {return x != null})\r\n\t\t\t\t\r\n\t\t\t\tvar keysDiffer = false\r\n\t\t\t\tif (data.length != cached.length) keysDiffer = true\r\n\t\t\t\telse for (var i = 0, cachedCell, dataCell; cachedCell = cached[i], dataCell = data[i]; i++) {\r\n\t\t\t\t\tif (cachedCell.attrs && dataCell.attrs && cachedCell.attrs.key != dataCell.attrs.key) {\r\n\t\t\t\t\t\tkeysDiffer = true\r\n\t\t\t\t\t\tbreak\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif (keysDiffer) {\r\n\t\t\t\t\tfor (var i = 0, len = data.length; i < len; i++) {\r\n\t\t\t\t\t\tif (data[i] && data[i].attrs) {\r\n\t\t\t\t\t\t\tif (data[i].attrs.key != null) {\r\n\t\t\t\t\t\t\t\tvar key = data[i].attrs.key;\r\n\t\t\t\t\t\t\t\tif (!existing[key]) existing[key] = {action: INSERTION, index: i};\r\n\t\t\t\t\t\t\t\telse existing[key] = {\r\n\t\t\t\t\t\t\t\t\taction: MOVE,\r\n\t\t\t\t\t\t\t\t\tindex: i,\r\n\t\t\t\t\t\t\t\t\tfrom: existing[key].index,\r\n\t\t\t\t\t\t\t\t\telement: cached.nodes[existing[key].index] || $document.createElement(\"div\")\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse unkeyed.push({index: i, element: parentElement.childNodes[i] || $document.createElement(\"div\")})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar actions = []\r\n\t\t\t\t\tfor (var prop in existing) actions.push(existing[prop])\r\n\t\t\t\t\tvar changes = actions.sort(sortChanges);\r\n\t\t\t\t\tvar newCached = new Array(cached.length)\r\n\r\n\t\t\t\t\tfor (var i = 0, change; change = changes[i]; i++) {\r\n\t\t\t\t\t\tif (change.action === DELETION) {\r\n\t\t\t\t\t\t\tclear(cached[change.index].nodes, cached[change.index]);\r\n\t\t\t\t\t\t\tnewCached.splice(change.index, 1)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (change.action === INSERTION) {\r\n\t\t\t\t\t\t\tvar dummy = $document.createElement(\"div\");\r\n\t\t\t\t\t\t\tdummy.key = data[change.index].attrs.key;\r\n\t\t\t\t\t\t\tparentElement.insertBefore(dummy, parentElement.childNodes[change.index] || null);\r\n\t\t\t\t\t\t\tnewCached.splice(change.index, 0, {attrs: {key: data[change.index].attrs.key}, nodes: [dummy]})\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (change.action === MOVE) {\r\n\t\t\t\t\t\t\tif (parentElement.childNodes[change.index] !== change.element && change.element !== null) {\r\n\t\t\t\t\t\t\t\tparentElement.insertBefore(change.element, parentElement.childNodes[change.index] || null)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tnewCached[change.index] = cached[change.from]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (var i = 0, len = unkeyed.length; i < len; i++) {\r\n\t\t\t\t\t\tvar change = unkeyed[i];\r\n\t\t\t\t\t\tparentElement.insertBefore(change.element, parentElement.childNodes[change.index] || null);\r\n\t\t\t\t\t\tnewCached[change.index] = cached[change.index]\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcached = newCached;\r\n\t\t\t\t\tcached.nodes = new Array(parentElement.childNodes.length);\r\n\t\t\t\t\tfor (var i = 0, child; child = parentElement.childNodes[i]; i++) cached.nodes[i] = child\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//end key algorithm\r\n\r\n\t\t\tfor (var i = 0, cacheCount = 0, len = data.length; i < len; i++) {\r\n\t\t\t\t//diff each item in the array\r\n\t\t\t\tvar item = build(parentElement, parentTag, cached, index, data[i], cached[cacheCount], shouldReattach, index + subArrayCount || subArrayCount, editable, namespace, configs);\r\n\t\t\t\tif (item === undefined) continue;\r\n\t\t\t\tif (!item.nodes.intact) intact = false;\r\n\t\t\t\tif (item.$trusted) {\r\n\t\t\t\t\t//fix offset of next element if item was a trusted string w/ more than one html element\r\n\t\t\t\t\t//the first clause in the regexp matches elements\r\n\t\t\t\t\t//the second clause (after the pipe) matches text nodes\r\n\t\t\t\t\tsubArrayCount += (item.match(/<[^\\/]|\\>\\s*[^<]/g) || []).length\r\n\t\t\t\t}\r\n\t\t\t\telse subArrayCount += type.call(item) === ARRAY ? item.length : 1;\r\n\t\t\t\tcached[cacheCount++] = item\r\n\t\t\t}\r\n\t\t\tif (!intact) {\r\n\t\t\t\t//diff the array itself\r\n\t\t\t\t\r\n\t\t\t\t//update the list of DOM nodes by collecting the nodes from each item\r\n\t\t\t\tfor (var i = 0, len = data.length; i < len; i++) {\r\n\t\t\t\t\tif (cached[i] != null) nodes.push.apply(nodes, cached[i].nodes)\r\n\t\t\t\t}\r\n\t\t\t\t//remove items from the end of the array if the new array is shorter than the old one\r\n\t\t\t\t//if errors ever happen here, the issue is most likely a bug in the construction of the `cached` data structure somewhere earlier in the program\r\n\t\t\t\tfor (var i = 0, node; node = cached.nodes[i]; i++) {\r\n\t\t\t\t\tif (node.parentNode != null && nodes.indexOf(node) < 0) clear([node], [cached[i]])\r\n\t\t\t\t}\r\n\t\t\t\tif (data.length < cached.length) cached.length = data.length;\r\n\t\t\t\tcached.nodes = nodes\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (data != null && dataType === OBJECT) {\r\n\t\t\tif (!data.attrs) data.attrs = {};\r\n\t\t\tif (!cached.attrs) cached.attrs = {};\r\n\r\n\t\t\tvar dataAttrKeys = Object.keys(data.attrs)\r\n\t\t\tvar hasKeys = dataAttrKeys.length > (\"key\" in data.attrs ? 1 : 0)\r\n\t\t\t//if an element is different enough from the one in cache, recreate it\r\n\t\t\tif (data.tag != cached.tag || dataAttrKeys.join() != Object.keys(cached.attrs).join() || data.attrs.id != cached.attrs.id) {\r\n\t\t\t\tif (cached.nodes.length) clear(cached.nodes);\r\n\t\t\t\tif (cached.configContext && typeof cached.configContext.onunload === FUNCTION) cached.configContext.onunload()\r\n\t\t\t}\r\n\t\t\tif (type.call(data.tag) != STRING) return;\r\n\r\n\t\t\tvar node, isNew = cached.nodes.length === 0;\r\n\t\t\tif (data.attrs.xmlns) namespace = data.attrs.xmlns;\r\n\t\t\telse if (data.tag === \"svg\") namespace = \"http://www.w3.org/2000/svg\";\r\n\t\t\telse if (data.tag === \"math\") namespace = \"http://www.w3.org/1998/Math/MathML\";\r\n\t\t\tif (isNew) {\r\n\t\t\t\tif (data.attrs.is) node = namespace === undefined ? $document.createElement(data.tag, data.attrs.is) : $document.createElementNS(namespace, data.tag, data.attrs.is);\r\n\t\t\t\telse node = namespace === undefined ? $document.createElement(data.tag) : $document.createElementNS(namespace, data.tag);\r\n\t\t\t\tcached = {\r\n\t\t\t\t\ttag: data.tag,\r\n\t\t\t\t\t//set attributes first, then create children\r\n\t\t\t\t\tattrs: hasKeys ? setAttributes(node, data.tag, data.attrs, {}, namespace) : data.attrs,\r\n\t\t\t\t\tchildren: data.children != null && data.children.length > 0 ?\r\n\t\t\t\t\t\tbuild(node, data.tag, undefined, undefined, data.children, cached.children, true, 0, data.attrs.contenteditable ? node : editable, namespace, configs) :\r\n\t\t\t\t\t\tdata.children,\r\n\t\t\t\t\tnodes: [node]\r\n\t\t\t\t};\r\n\t\t\t\tif (cached.children && !cached.children.nodes) cached.children.nodes = [];\r\n\t\t\t\t//edge case: setting value on <select> doesn't work before children exist, so set it again after children have been created\r\n\t\t\t\tif (data.tag === \"select\" && data.attrs.value) setAttributes(node, data.tag, {value: data.attrs.value}, {}, namespace);\r\n\t\t\t\tparentElement.insertBefore(node, parentElement.childNodes[index] || null)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tnode = cached.nodes[0];\r\n\t\t\t\tif (hasKeys) setAttributes(node, data.tag, data.attrs, cached.attrs, namespace);\r\n\t\t\t\tcached.children = build(node, data.tag, undefined, undefined, data.children, cached.children, false, 0, data.attrs.contenteditable ? node : editable, namespace, configs);\r\n\t\t\t\tcached.nodes.intact = true;\r\n\t\t\t\tif (shouldReattach === true && node != null) parentElement.insertBefore(node, parentElement.childNodes[index] || null)\r\n\t\t\t}\r\n\t\t\t//schedule configs to be called. They are called after `build` finishes running\r\n\t\t\tif (typeof data.attrs[\"config\"] === FUNCTION) {\r\n\t\t\t\tvar context = cached.configContext = cached.configContext || {};\r\n\r\n\t\t\t\t// bind\r\n\t\t\t\tvar callback = function(data, args) {\r\n\t\t\t\t\treturn function() {\r\n\t\t\t\t\t\treturn data.attrs[\"config\"].apply(data, args)\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tconfigs.push(callback(data, [node, !isNew, context, cached]))\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (typeof dataType != FUNCTION) {\r\n\t\t\t//handle text nodes\r\n\t\t\tvar nodes;\r\n\t\t\tif (cached.nodes.length === 0) {\r\n\t\t\t\tif (data.$trusted) {\r\n\t\t\t\t\tnodes = injectHTML(parentElement, index, data)\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tnodes = [$document.createTextNode(data)];\r\n\t\t\t\t\tif (!parentElement.nodeName.match(voidElements)) parentElement.insertBefore(nodes[0], parentElement.childNodes[index] || null)\r\n\t\t\t\t}\r\n\t\t\t\tcached = \"string number boolean\".indexOf(typeof data) > -1 ? new data.constructor(data) : data;\r\n\t\t\t\tcached.nodes = nodes\r\n\t\t\t}\r\n\t\t\telse if (cached.valueOf() !== data.valueOf() || shouldReattach === true) {\r\n\t\t\t\tnodes = cached.nodes;\r\n\t\t\t\tif (!editable || editable !== $document.activeElement) {\r\n\t\t\t\t\tif (data.$trusted) {\r\n\t\t\t\t\t\tclear(nodes, cached);\r\n\t\t\t\t\t\tnodes = injectHTML(parentElement, index, data)\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\t//corner case: replacing the nodeValue of a text node that is a child of a textarea/contenteditable doesn't work\r\n\t\t\t\t\t\t//we need to update the value property of the parent textarea or the innerHTML of the contenteditable element instead\r\n\t\t\t\t\t\tif (parentTag === \"textarea\") parentElement.value = data;\r\n\t\t\t\t\t\telse if (editable) editable.innerHTML = data;\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tif (nodes[0].nodeType === 1 || nodes.length > 1) { //was a trusted string\r\n\t\t\t\t\t\t\t\tclear(cached.nodes, cached);\r\n\t\t\t\t\t\t\t\tnodes = [$document.createTextNode(data)]\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tparentElement.insertBefore(nodes[0], parentElement.childNodes[index] || null);\r\n\t\t\t\t\t\t\tnodes[0].nodeValue = data\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcached = new data.constructor(data);\r\n\t\t\t\tcached.nodes = nodes\r\n\t\t\t}\r\n\t\t\telse cached.nodes.intact = true\r\n\t\t}\r\n\r\n\t\treturn cached\r\n\t}\r\n\tfunction sortChanges(a, b) {return a.action - b.action || a.index - b.index}\r\n\tfunction setAttributes(node, tag, dataAttrs, cachedAttrs, namespace) {\r\n\t\tfor (var attrName in dataAttrs) {\r\n\t\t\tvar dataAttr = dataAttrs[attrName];\r\n\t\t\tvar cachedAttr = cachedAttrs[attrName];\r\n\t\t\tif (!(attrName in cachedAttrs) || (cachedAttr !== dataAttr)) {\r\n\t\t\t\tcachedAttrs[attrName] = dataAttr;\r\n\t\t\t\ttry {\r\n\t\t\t\t\t//`config` isn't a real attributes, so ignore it\r\n\t\t\t\t\tif (attrName === \"config\" || attrName == \"key\") continue;\r\n\t\t\t\t\t//hook event handlers to the auto-redrawing system\r\n\t\t\t\t\telse if (typeof dataAttr === FUNCTION && attrName.indexOf(\"on\") === 0) {\r\n\t\t\t\t\t\tnode[attrName] = autoredraw(dataAttr, node)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//handle `style: {...}`\r\n\t\t\t\t\telse if (attrName === \"style\" && dataAttr != null && type.call(dataAttr) === OBJECT) {\r\n\t\t\t\t\t\tfor (var rule in dataAttr) {\r\n\t\t\t\t\t\t\tif (cachedAttr == null || cachedAttr[rule] !== dataAttr[rule]) node.style[rule] = dataAttr[rule]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfor (var rule in cachedAttr) {\r\n\t\t\t\t\t\t\tif (!(rule in dataAttr)) node.style[rule] = \"\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//handle SVG\r\n\t\t\t\t\telse if (namespace != null) {\r\n\t\t\t\t\t\tif (attrName === \"href\") node.setAttributeNS(\"http://www.w3.org/1999/xlink\", \"href\", dataAttr);\r\n\t\t\t\t\t\telse if (attrName === \"className\") node.setAttribute(\"class\", dataAttr);\r\n\t\t\t\t\t\telse node.setAttribute(attrName, dataAttr)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//handle cases that are properties (but ignore cases where we should use setAttribute instead)\r\n\t\t\t\t\t//- list and form are typically used as strings, but are DOM element references in js\r\n\t\t\t\t\t//- when using CSS selectors (e.g. `m(\"[style='']\")`), style is used as a string, but it's an object in js\r\n\t\t\t\t\telse if (attrName in node && !(attrName === \"list\" || attrName === \"style\" || attrName === \"form\" || attrName === \"type\")) {\r\n\t\t\t\t\t\t//#348 don't set the value if not needed otherwise cursor placement breaks in Chrome\r\n\t\t\t\t\t\tif (tag !== \"input\" || node[attrName] !== dataAttr) node[attrName] = dataAttr\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse node.setAttribute(attrName, dataAttr)\r\n\t\t\t\t}\r\n\t\t\t\tcatch (e) {\r\n\t\t\t\t\t//swallow IE's invalid argument errors to mimic HTML's fallback-to-doing-nothing-on-invalid-attributes behavior\r\n\t\t\t\t\tif (e.message.indexOf(\"Invalid argument\") < 0) throw e\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//#348 dataAttr may not be a string, so use loose comparison (double equal) instead of strict (triple equal)\r\n\t\t\telse if (attrName === \"value\" && tag === \"input\" && node.value != dataAttr) {\r\n\t\t\t\tnode.value = dataAttr\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn cachedAttrs\r\n\t}\r\n\tfunction clear(nodes, cached) {\r\n\t\tfor (var i = nodes.length - 1; i > -1; i--) {\r\n\t\t\tif (nodes[i] && nodes[i].parentNode) {\r\n\t\t\t\ttry {nodes[i].parentNode.removeChild(nodes[i])}\r\n\t\t\t\tcatch (e) {} //ignore if this fails due to order of events (see http://stackoverflow.com/questions/21926083/failed-to-execute-removechild-on-node)\r\n\t\t\t\tcached = [].concat(cached);\r\n\t\t\t\tif (cached[i]) unload(cached[i])\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (nodes.length != 0) nodes.length = 0\r\n\t}\r\n\tfunction unload(cached) {\r\n\t\tif (cached.configContext && typeof cached.configContext.onunload === FUNCTION) cached.configContext.onunload();\r\n\t\tif (cached.children) {\r\n\t\t\tif (type.call(cached.children) === ARRAY) {\r\n\t\t\t\tfor (var i = 0, child; child = cached.children[i]; i++) unload(child)\r\n\t\t\t}\r\n\t\t\telse if (cached.children.tag) unload(cached.children)\r\n\t\t}\r\n\t}\r\n\tfunction injectHTML(parentElement, index, data) {\r\n\t\tvar nextSibling = parentElement.childNodes[index];\r\n\t\tif (nextSibling) {\r\n\t\t\tvar isElement = nextSibling.nodeType != 1;\r\n\t\t\tvar placeholder = $document.createElement(\"span\");\r\n\t\t\tif (isElement) {\r\n\t\t\t\tparentElement.insertBefore(placeholder, nextSibling || null);\r\n\t\t\t\tplaceholder.insertAdjacentHTML(\"beforebegin\", data);\r\n\t\t\t\tparentElement.removeChild(placeholder)\r\n\t\t\t}\r\n\t\t\telse nextSibling.insertAdjacentHTML(\"beforebegin\", data)\r\n\t\t}\r\n\t\telse parentElement.insertAdjacentHTML(\"beforeend\", data);\r\n\t\tvar nodes = [];\r\n\t\twhile (parentElement.childNodes[index] !== nextSibling) {\r\n\t\t\tnodes.push(parentElement.childNodes[index]);\r\n\t\t\tindex++\r\n\t\t}\r\n\t\treturn nodes\r\n\t}\r\n\tfunction autoredraw(callback, object) {\r\n\t\treturn function(e) {\r\n\t\t\te = e || event;\r\n\t\t\tm.redraw.strategy(\"diff\");\r\n\t\t\tm.startComputation();\r\n\t\t\ttry {return callback.call(object, e)}\r\n\t\t\tfinally {\r\n\t\t\t\tendFirstComputation()\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tvar html;\r\n\tvar documentNode = {\r\n\t\tappendChild: function(node) {\r\n\t\t\tif (html === undefined) html = $document.createElement(\"html\");\r\n\t\t\tif ($document.documentElement && $document.documentElement !== node) {\r\n\t\t\t\t$document.replaceChild(node, $document.documentElement)\r\n\t\t\t}\r\n\t\t\telse $document.appendChild(node);\r\n\t\t\tthis.childNodes = $document.childNodes\r\n\t\t},\r\n\t\tinsertBefore: function(node) {\r\n\t\t\tthis.appendChild(node)\r\n\t\t},\r\n\t\tchildNodes: []\r\n\t};\r\n\tvar nodeCache = [], cellCache = {};\r\n\tm.render = function(root, cell, forceRecreation) {\r\n\t\tvar configs = [];\r\n\t\tif (!root) throw new Error(\"Please ensure the DOM element exists before rendering a template into it.\");\r\n\t\tvar id = getCellCacheKey(root);\r\n\t\tvar isDocumentRoot = root === $document;\r\n\t\tvar node = isDocumentRoot || root === $document.documentElement ? documentNode : root;\r\n\t\tif (isDocumentRoot && cell.tag != \"html\") cell = {tag: \"html\", attrs: {}, children: cell};\r\n\t\tif (cellCache[id] === undefined) clear(node.childNodes);\r\n\t\tif (forceRecreation === true) reset(root);\r\n\t\tcellCache[id] = build(node, null, undefined, undefined, cell, cellCache[id], false, 0, null, undefined, configs);\r\n\t\tfor (var i = 0, len = configs.length; i < len; i++) configs[i]()\r\n\t};\r\n\tfunction getCellCacheKey(element) {\r\n\t\tvar index = nodeCache.indexOf(element);\r\n\t\treturn index < 0 ? nodeCache.push(element) - 1 : index\r\n\t}\r\n\r\n\tm.trust = function(value) {\r\n\t\tvalue = new String(value);\r\n\t\tvalue.$trusted = true;\r\n\t\treturn value\r\n\t};\r\n\r\n\tfunction gettersetter(store) {\r\n\t\tvar prop = function() {\r\n\t\t\tif (arguments.length) store = arguments[0];\r\n\t\t\treturn store\r\n\t\t};\r\n\r\n\t\tprop.toJSON = function() {\r\n\t\t\treturn store\r\n\t\t};\r\n\r\n\t\treturn prop\r\n\t}\r\n\r\n\tm.prop = function (store) {\r\n\t\t//note: using non-strict equality check here because we're checking if store is null OR undefined\r\n\t\tif (((store != null && type.call(store) === OBJECT) || typeof store === FUNCTION) && typeof store.then === FUNCTION) {\r\n\t\t\treturn propify(store)\r\n\t\t}\r\n\r\n\t\treturn gettersetter(store)\r\n\t};\r\n\r\n\tvar roots = [], modules = [], controllers = [], lastRedrawId = null, lastRedrawCallTime = 0, computePostRedrawHook = null, prevented = false, topModule;\r\n\tvar FRAME_BUDGET = 16; //60 frames per second = 1 call per 16 ms\r\n\tm.module = function(root, module) {\r\n\t\tif (!root) throw new Error(\"Please ensure the DOM element exists before rendering a template into it.\");\r\n\t\tvar index = roots.indexOf(root);\r\n\t\tif (index < 0) index = roots.length;\r\n\t\tvar isPrevented = false;\r\n\t\tif (controllers[index] && typeof controllers[index].onunload === FUNCTION) {\r\n\t\t\tvar event = {\r\n\t\t\t\tpreventDefault: function() {isPrevented = true}\r\n\t\t\t};\r\n\t\t\tcontrollers[index].onunload(event)\r\n\t\t}\r\n\t\tif (!isPrevented) {\r\n\t\t\tm.redraw.strategy(\"all\");\r\n\t\t\tm.startComputation();\r\n\t\t\troots[index] = root;\r\n\t\t\tvar currentModule = topModule = module = module || {};\r\n\t\t\tvar controller = new (module.controller || function() {});\r\n\t\t\t//controllers may call m.module recursively (via m.route redirects, for example)\r\n\t\t\t//this conditional ensures only the last recursive m.module call is applied\r\n\t\t\tif (currentModule === topModule) {\r\n\t\t\t\tcontrollers[index] = controller;\r\n\t\t\t\tmodules[index] = module\r\n\t\t\t}\r\n\t\t\tendFirstComputation();\r\n\t\t\treturn controllers[index]\r\n\t\t}\r\n\t};\r\n\tm.redraw = function(force) {\r\n\t\t//lastRedrawId is a positive number if a second redraw is requested before the next animation frame\r\n\t\t//lastRedrawID is null if it's the first redraw and not an event handler\r\n\t\tif (lastRedrawId && force !== true) {\r\n\t\t\t//when setTimeout: only reschedule redraw if time between now and previous redraw is bigger than a frame, otherwise keep currently scheduled timeout\r\n\t\t\t//when rAF: always reschedule redraw\r\n\t\t\tif (new Date - lastRedrawCallTime > FRAME_BUDGET || $requestAnimationFrame === window.requestAnimationFrame) {\r\n\t\t\t\tif (lastRedrawId > 0) $cancelAnimationFrame(lastRedrawId);\r\n\t\t\t\tlastRedrawId = $requestAnimationFrame(redraw, FRAME_BUDGET)\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tredraw();\r\n\t\t\tlastRedrawId = $requestAnimationFrame(function() {lastRedrawId = null}, FRAME_BUDGET)\r\n\t\t}\r\n\t};\r\n\tm.redraw.strategy = m.prop();\r\n\tvar blank = function() {return \"\"}\r\n\tfunction redraw() {\r\n\t\tvar forceRedraw = m.redraw.strategy() === \"all\";\r\n\t\tfor (var i = 0, root; root = roots[i]; i++) {\r\n\t\t\tif (controllers[i]) {\r\n\t\t\t\tm.render(root, modules[i].view ? modules[i].view(controllers[i]) : blank(), forceRedraw)\r\n\t\t\t}\r\n\t\t}\r\n\t\t//after rendering within a routed context, we need to scroll back to the top, and fetch the document title for history.pushState\r\n\t\tif (computePostRedrawHook) {\r\n\t\t\tcomputePostRedrawHook();\r\n\t\t\tcomputePostRedrawHook = null\r\n\t\t}\r\n\t\tlastRedrawId = null;\r\n\t\tlastRedrawCallTime = new Date;\r\n\t\tm.redraw.strategy(\"diff\")\r\n\t}\r\n\r\n\tvar pendingRequests = 0;\r\n\tm.startComputation = function() {pendingRequests++};\r\n\tm.endComputation = function() {\r\n\t\tpendingRequests = Math.max(pendingRequests - 1, 0);\r\n\t\tif (pendingRequests === 0) m.redraw()\r\n\t};\r\n\tvar endFirstComputation = function() {\r\n\t\tif (m.redraw.strategy() == \"none\") {\r\n\t\t\tpendingRequests--\r\n\t\t\tm.redraw.strategy(\"diff\")\r\n\t\t}\r\n\t\telse m.endComputation();\r\n\t}\r\n\r\n\tm.withAttr = function(prop, withAttrCallback) {\r\n\t\treturn function(e) {\r\n\t\t\te = e || event;\r\n\t\t\tvar currentTarget = e.currentTarget || this;\r\n\t\t\twithAttrCallback(prop in currentTarget ? currentTarget[prop] : currentTarget.getAttribute(prop))\r\n\t\t}\r\n\t};\r\n\r\n\t//routing\r\n\tvar modes = {pathname: \"\", hash: \"#\", search: \"?\"};\r\n\tvar redirect = function() {}, routeParams, currentRoute;\r\n\tm.route = function() {\r\n\t\t//m.route()\r\n\t\tif (arguments.length === 0) return currentRoute;\r\n\t\t//m.route(el, defaultRoute, routes)\r\n\t\telse if (arguments.length === 3 && type.call(arguments[1]) === STRING) {\r\n\t\t\tvar root = arguments[0], defaultRoute = arguments[1], router = arguments[2];\r\n\t\t\tredirect = function(source) {\r\n\t\t\t\tvar path = currentRoute = normalizeRoute(source);\r\n\t\t\t\tif (!routeByValue(root, router, path)) {\r\n\t\t\t\t\tm.route(defaultRoute, true)\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvar listener = m.route.mode === \"hash\" ? \"onhashchange\" : \"onpopstate\";\r\n\t\t\twindow[listener] = function() {\r\n\t\t\t\tvar path = $location[m.route.mode]\r\n\t\t\t\tif (m.route.mode === \"pathname\") path += $location.search\r\n\t\t\t\tif (currentRoute != normalizeRoute(path)) {\r\n\t\t\t\t\tredirect(path)\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tcomputePostRedrawHook = setScroll;\r\n\t\t\twindow[listener]()\r\n\t\t}\r\n\t\t//config: m.route\r\n\t\telse if (arguments[0].addEventListener) {\r\n\t\t\tvar element = arguments[0];\r\n\t\t\tvar isInitialized = arguments[1];\r\n\t\t\tvar context = arguments[2];\r\n\t\t\telement.href = (m.route.mode !== 'pathname' ? $location.pathname : '') + modes[m.route.mode] + this.attrs.href;\r\n\t\t\telement.removeEventListener(\"click\", routeUnobtrusive);\r\n\t\t\telement.addEventListener(\"click\", routeUnobtrusive)\r\n\t\t}\r\n\t\t//m.route(route, params)\r\n\t\telse if (type.call(arguments[0]) === STRING) {\r\n\t\t\tvar oldRoute = currentRoute;\r\n\t\t\tcurrentRoute = arguments[0];\r\n\t\t\tvar args = arguments[1] || {}\r\n\t\t\tvar queryIndex = currentRoute.indexOf(\"?\")\r\n\t\t\tvar params = queryIndex > -1 ? parseQueryString(currentRoute.slice(queryIndex + 1)) : {}\r\n\t\t\tfor (var i in args) params[i] = args[i]\r\n\t\t\tvar querystring = buildQueryString(params)\r\n\t\t\tvar currentPath = queryIndex > -1 ? currentRoute.slice(0, queryIndex) : currentRoute\r\n\t\t\tif (querystring) currentRoute = currentPath + (currentPath.indexOf(\"?\") === -1 ? \"?\" : \"&\") + querystring;\r\n\r\n\t\t\tvar shouldReplaceHistoryEntry = (arguments.length === 3 ? arguments[2] : arguments[1]) === true || oldRoute === arguments[0];\r\n\r\n\t\t\tif (window.history.pushState) {\r\n\t\t\t\tcomputePostRedrawHook = function() {\r\n\t\t\t\t\twindow.history[shouldReplaceHistoryEntry ? \"replaceState\" : \"pushState\"](null, $document.title, modes[m.route.mode] + currentRoute);\r\n\t\t\t\t\tsetScroll()\r\n\t\t\t\t};\r\n\t\t\t\tredirect(modes[m.route.mode] + currentRoute)\r\n\t\t\t}\r\n\t\t\telse $location[m.route.mode] = currentRoute\r\n\t\t}\r\n\t};\r\n\tm.route.param = function(key) {\r\n\t\tif (!routeParams) throw new Error(\"You must call m.route(element, defaultRoute, routes) before calling m.route.param()\")\r\n\t\treturn routeParams[key]\r\n\t};\r\n\tm.route.mode = \"search\";\r\n\tfunction normalizeRoute(route) {\r\n\t\treturn route.slice(modes[m.route.mode].length)\r\n\t}\r\n\tfunction routeByValue(root, router, path) {\r\n\t\trouteParams = {};\r\n\r\n\t\tvar queryStart = path.indexOf(\"?\");\r\n\t\tif (queryStart !== -1) {\r\n\t\t\trouteParams = parseQueryString(path.substr(queryStart + 1, path.length));\r\n\t\t\tpath = path.substr(0, queryStart)\r\n\t\t}\r\n\r\n\t\tfor (var route in router) {\r\n\t\t\tif (route === path) {\r\n\t\t\t\tm.module(root, router[route]);\r\n\t\t\t\treturn true\r\n\t\t\t}\r\n\r\n\t\t\tvar matcher = new RegExp(\"^\" + route.replace(/:[^\\/]+?\\.{3}/g, \"(.*?)\").replace(/:[^\\/]+/g, \"([^\\\\/]+)\") + \"\\/?$\");\r\n\r\n\t\t\tif (matcher.test(path)) {\r\n\t\t\t\tpath.replace(matcher, function() {\r\n\t\t\t\t\tvar keys = route.match(/:[^\\/]+/g) || [];\r\n\t\t\t\t\tvar values = [].slice.call(arguments, 1, -2);\r\n\t\t\t\t\tfor (var i = 0, len = keys.length; i < len; i++) routeParams[keys[i].replace(/:|\\./g, \"\")] = decodeURIComponent(values[i])\r\n\t\t\t\t\tm.module(root, router[route])\r\n\t\t\t\t});\r\n\t\t\t\treturn true\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tfunction routeUnobtrusive(e) {\r\n\t\te = e || event;\r\n\t\tif (e.ctrlKey || e.metaKey || e.which === 2) return;\r\n\t\tif (e.preventDefault) e.preventDefault();\r\n\t\telse e.returnValue = false;\r\n\t\tvar currentTarget = e.currentTarget || this;\r\n\t\tvar args = m.route.mode === \"pathname\" && currentTarget.search ? parseQueryString(currentTarget.search.slice(1)) : {};\r\n\t\tm.route(currentTarget[m.route.mode].slice(modes[m.route.mode].length), args)\r\n\t}\r\n\tfunction setScroll() {\r\n\t\tif (m.route.mode != \"hash\" && $location.hash) $location.hash = $location.hash;\r\n\t\telse window.scrollTo(0, 0)\r\n\t}\r\n\tfunction buildQueryString(object, prefix) {\r\n\t\tvar str = [];\r\n\t\tfor(var prop in object) {\r\n\t\t\tvar key = prefix ? prefix + \"[\" + prop + \"]\" : prop, value = object[prop];\r\n\t\t\tvar valueType = type.call(value)\r\n\t\t\tvar pair = value != null && (valueType === OBJECT) ?\r\n\t\t\t\tbuildQueryString(value, key) :\r\n\t\t\t\tvalueType === ARRAY ?\r\n\t\t\t\t\tvalue.map(function(item) {return encodeURIComponent(key + \"[]\") + \"=\" + encodeURIComponent(item)}).join(\"&\") :\r\n\t\t\t\t\tencodeURIComponent(key) + \"=\" + encodeURIComponent(value)\r\n\t\t\tstr.push(pair)\r\n\t\t}\r\n\t\treturn str.join(\"&\")\r\n\t}\r\n\t\r\n\tfunction parseQueryString(str) {\r\n\t\tvar pairs = str.split(\"&\"), params = {};\r\n\t\tfor (var i = 0, len = pairs.length; i < len; i++) {\r\n\t\t\tvar pair = pairs[i].split(\"=\");\r\n\t\t\tparams[decodeURIComponent(pair[0])] = pair[1] ? decodeURIComponent(pair[1]) : \"\"\r\n\t\t}\r\n\t\treturn params\r\n\t}\r\n\tfunction reset(root) {\r\n\t\tvar cacheKey = getCellCacheKey(root);\r\n\t\tclear(root.childNodes, cellCache[cacheKey]);\r\n\t\tcellCache[cacheKey] = undefined\r\n\t}\r\n\r\n\tm.deferred = function () {\r\n\t\tvar deferred = new Deferred();\r\n\t\tdeferred.promise = propify(deferred.promise);\r\n\t\treturn deferred\r\n\t};\r\n\tfunction propify(promise) {\r\n\t\tvar prop = m.prop();\r\n\t\tpromise.then(prop);\r\n\t\tprop.then = function(resolve, reject) {\r\n\t\t\treturn propify(promise.then(resolve, reject))\r\n\t\t};\r\n\t\treturn prop\r\n\t}\r\n\t//Promiz.mithril.js | Zolmeister | MIT\r\n\t//a modified version of Promiz.js, which does not conform to Promises/A+ for two reasons:\r\n\t//1) `then` callbacks are called synchronously (because setTimeout is too slow, and the setImmediate polyfill is too big\r\n\t//2) throwing subclasses of Error cause the error to be bubbled up instead of triggering rejection (because the spec does not account for the important use case of default browser error handling, i.e. message w/ line number)\r\n\tfunction Deferred(successCallback, failureCallback) {\r\n\t\tvar RESOLVING = 1, REJECTING = 2, RESOLVED = 3, REJECTED = 4;\r\n\t\tvar self = this, state = 0, promiseValue = 0, next = [];\r\n\r\n\t\tself[\"promise\"] = {};\r\n\r\n\t\tself[\"resolve\"] = function(value) {\r\n\t\t\tif (!state) {\r\n\t\t\t\tpromiseValue = value;\r\n\t\t\t\tstate = RESOLVING;\r\n\r\n\t\t\t\tfire()\r\n\t\t\t}\r\n\t\t\treturn this\r\n\t\t};\r\n\r\n\t\tself[\"reject\"] = function(value) {\r\n\t\t\tif (!state) {\r\n\t\t\t\tpromiseValue = value;\r\n\t\t\t\tstate = REJECTING;\r\n\r\n\t\t\t\tfire()\r\n\t\t\t}\r\n\t\t\treturn this\r\n\t\t};\r\n\r\n\t\tself.promise[\"then\"] = function(successCallback, failureCallback) {\r\n\t\t\tvar deferred = new Deferred(successCallback, failureCallback);\r\n\t\t\tif (state === RESOLVED) {\r\n\t\t\t\tdeferred.resolve(promiseValue)\r\n\t\t\t}\r\n\t\t\telse if (state === REJECTED) {\r\n\t\t\t\tdeferred.reject(promiseValue)\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tnext.push(deferred)\r\n\t\t\t}\r\n\t\t\treturn deferred.promise\r\n\t\t};\r\n\r\n\t\tfunction finish(type) {\r\n\t\t\tstate = type || REJECTED;\r\n\t\t\tnext.map(function(deferred) {\r\n\t\t\t\tstate === RESOLVED && deferred.resolve(promiseValue) || deferred.reject(promiseValue)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tfunction thennable(then, successCallback, failureCallback, notThennableCallback) {\r\n\t\t\tif (((promiseValue != null && type.call(promiseValue) === OBJECT) || typeof promiseValue === FUNCTION) && typeof then === FUNCTION) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// count protects against abuse calls from spec checker\r\n\t\t\t\t\tvar count = 0;\r\n\t\t\t\t\tthen.call(promiseValue, function(value) {\r\n\t\t\t\t\t\tif (count++) return;\r\n\t\t\t\t\t\tpromiseValue = value;\r\n\t\t\t\t\t\tsuccessCallback()\r\n\t\t\t\t\t}, function (value) {\r\n\t\t\t\t\t\tif (count++) return;\r\n\t\t\t\t\t\tpromiseValue = value;\r\n\t\t\t\t\t\tfailureCallback()\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t\tcatch (e) {\r\n\t\t\t\t\tm.deferred.onerror(e);\r\n\t\t\t\t\tpromiseValue = e;\r\n\t\t\t\t\tfailureCallback()\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tnotThennableCallback()\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction fire() {\r\n\t\t\t// check if it's a thenable\r\n\t\t\tvar then;\r\n\t\t\ttry {\r\n\t\t\t\tthen = promiseValue && promiseValue.then\r\n\t\t\t}\r\n\t\t\tcatch (e) {\r\n\t\t\t\tm.deferred.onerror(e);\r\n\t\t\t\tpromiseValue = e;\r\n\t\t\t\tstate = REJECTING;\r\n\t\t\t\treturn fire()\r\n\t\t\t}\r\n\t\t\tthennable(then, function() {\r\n\t\t\t\tstate = RESOLVING;\r\n\t\t\t\tfire()\r\n\t\t\t}, function() {\r\n\t\t\t\tstate = REJECTING;\r\n\t\t\t\tfire()\r\n\t\t\t}, function() {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif (state === RESOLVING && typeof successCallback === FUNCTION) {\r\n\t\t\t\t\t\tpromiseValue = successCallback(promiseValue)\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (state === REJECTING && typeof failureCallback === \"function\") {\r\n\t\t\t\t\t\tpromiseValue = failureCallback(promiseValue);\r\n\t\t\t\t\t\tstate = RESOLVING\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcatch (e) {\r\n\t\t\t\t\tm.deferred.onerror(e);\r\n\t\t\t\t\tpromiseValue = e;\r\n\t\t\t\t\treturn finish()\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (promiseValue === self) {\r\n\t\t\t\t\tpromiseValue = TypeError();\r\n\t\t\t\t\tfinish()\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthennable(then, function () {\r\n\t\t\t\t\t\tfinish(RESOLVED)\r\n\t\t\t\t\t}, finish, function () {\r\n\t\t\t\t\t\tfinish(state === RESOLVING && RESOLVED)\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\tm.deferred.onerror = function(e) {\r\n\t\tif (type.call(e) === \"[object Error]\" && !e.constructor.toString().match(/ Error/)) throw e\r\n\t};\r\n\r\n\tm.sync = function(args) {\r\n\t\tvar method = \"resolve\";\r\n\t\tfunction synchronizer(pos, resolved) {\r\n\t\t\treturn function(value) {\r\n\t\t\t\tresults[pos] = value;\r\n\t\t\t\tif (!resolved) method = \"reject\";\r\n\t\t\t\tif (--outstanding === 0) {\r\n\t\t\t\t\tdeferred.promise(results);\r\n\t\t\t\t\tdeferred[method](results)\r\n\t\t\t\t}\r\n\t\t\t\treturn value\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar deferred = m.deferred();\r\n\t\tvar outstanding = args.length;\r\n\t\tvar results = new Array(outstanding);\r\n\t\tif (args.length > 0) {\r\n\t\t\tfor (var i = 0; i < args.length; i++) {\r\n\t\t\t\targs[i].then(synchronizer(i, true), synchronizer(i, false))\r\n\t\t\t}\r\n\t\t}\r\n\t\telse deferred.resolve([]);\r\n\r\n\t\treturn deferred.promise\r\n\t};\r\n\tfunction identity(value) {return value}\r\n\r\n\tfunction ajax(options) {\r\n\t\tif (options.dataType && options.dataType.toLowerCase() === \"jsonp\") {\r\n\t\t\tvar callbackKey = \"mithril_callback_\" + new Date().getTime() + \"_\" + (Math.round(Math.random() * 1e16)).toString(36);\r\n\t\t\tvar script = $document.createElement(\"script\");\r\n\r\n\t\t\twindow[callbackKey] = function(resp) {\r\n\t\t\t\tscript.parentNode.removeChild(script);\r\n\t\t\t\toptions.onload({\r\n\t\t\t\t\ttype: \"load\",\r\n\t\t\t\t\ttarget: {\r\n\t\t\t\t\t\tresponseText: resp\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\twindow[callbackKey] = undefined\r\n\t\t\t};\r\n\r\n\t\t\tscript.onerror = function(e) {\r\n\t\t\t\tscript.parentNode.removeChild(script);\r\n\r\n\t\t\t\toptions.onerror({\r\n\t\t\t\t\ttype: \"error\",\r\n\t\t\t\t\ttarget: {\r\n\t\t\t\t\t\tstatus: 500,\r\n\t\t\t\t\t\tresponseText: JSON.stringify({error: \"Error making jsonp request\"})\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\twindow[callbackKey] = undefined;\r\n\r\n\t\t\t\treturn false\r\n\t\t\t};\r\n\r\n\t\t\tscript.onload = function(e) {\r\n\t\t\t\treturn false\r\n\t\t\t};\r\n\r\n\t\t\tscript.src = options.url\r\n\t\t\t\t+ (options.url.indexOf(\"?\") > 0 ? \"&\" : \"?\")\r\n\t\t\t\t+ (options.callbackKey ? options.callbackKey : \"callback\")\r\n\t\t\t\t+ \"=\" + callbackKey\r\n\t\t\t\t+ \"&\" + buildQueryString(options.data || {});\r\n\t\t\t$document.body.appendChild(script)\r\n\t\t}\r\n\t\telse {\r\n\t\t\tvar xhr = new window.XMLHttpRequest;\r\n\t\t\txhr.open(options.method, options.url, true, options.user, options.password);\r\n\t\t\txhr.onreadystatechange = function() {\r\n\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\tif (xhr.status >= 200 && xhr.status < 300) options.onload({type: \"load\", target: xhr});\r\n\t\t\t\t\telse options.onerror({type: \"error\", target: xhr})\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tif (options.serialize === JSON.stringify && options.data && options.method !== \"GET\") {\r\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/json; charset=utf-8\")\r\n\t\t\t}\r\n\t\t\tif (options.deserialize === JSON.parse) {\r\n\t\t\t\txhr.setRequestHeader(\"Accept\", \"application/json, text/*\");\r\n\t\t\t}\r\n\t\t\tif (typeof options.config === FUNCTION) {\r\n\t\t\t\tvar maybeXhr = options.config(xhr, options);\r\n\t\t\t\tif (maybeXhr != null) xhr = maybeXhr\r\n\t\t\t}\r\n\r\n\t\t\tvar data = options.method === \"GET\" || !options.data ? \"\" : options.data\r\n\t\t\tif (data && (type.call(data) != STRING && data.constructor != window.FormData)) {\r\n\t\t\t\tthrow \"Request data should be either be a string or FormData. Check the `serialize` option in `m.request`\";\r\n\t\t\t}\r\n\t\t\txhr.send(data);\r\n\t\t\treturn xhr\r\n\t\t}\r\n\t}\r\n\tfunction bindData(xhrOptions, data, serialize) {\r\n\t\tif (xhrOptions.method === \"GET\" && xhrOptions.dataType != \"jsonp\") {\r\n\t\t\tvar prefix = xhrOptions.url.indexOf(\"?\") < 0 ? \"?\" : \"&\";\r\n\t\t\tvar querystring = buildQueryString(data);\r\n\t\t\txhrOptions.url = xhrOptions.url + (querystring ? prefix + querystring : \"\")\r\n\t\t}\r\n\t\telse xhrOptions.data = serialize(data);\r\n\t\treturn xhrOptions\r\n\t}\r\n\tfunction parameterizeUrl(url, data) {\r\n\t\tvar tokens = url.match(/:[a-z]\\w+/gi);\r\n\t\tif (tokens && data) {\r\n\t\t\tfor (var i = 0; i < tokens.length; i++) {\r\n\t\t\t\tvar key = tokens[i].slice(1);\r\n\t\t\t\turl = url.replace(tokens[i], data[key]);\r\n\t\t\t\tdelete data[key]\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn url\r\n\t}\r\n\r\n\tm.request = function(xhrOptions) {\r\n\t\tif (xhrOptions.background !== true) m.startComputation();\r\n\t\tvar deferred = m.deferred();\r\n\t\tvar isJSONP = xhrOptions.dataType && xhrOptions.dataType.toLowerCase() === \"jsonp\";\r\n\t\tvar serialize = xhrOptions.serialize = isJSONP ? identity : xhrOptions.serialize || JSON.stringify;\r\n\t\tvar deserialize = xhrOptions.deserialize = isJSONP ? identity : xhrOptions.deserialize || JSON.parse;\r\n\t\tvar extract = xhrOptions.extract || function(xhr) {\r\n\t\t\treturn xhr.responseText.length === 0 && deserialize === JSON.parse ? null : xhr.responseText\r\n\t\t};\r\n\t\txhrOptions.url = parameterizeUrl(xhrOptions.url, xhrOptions.data);\r\n\t\txhrOptions = bindData(xhrOptions, xhrOptions.data, serialize);\r\n\t\txhrOptions.onload = xhrOptions.onerror = function(e) {\r\n\t\t\ttry {\r\n\t\t\t\te = e || event;\r\n\t\t\t\tvar unwrap = (e.type === \"load\" ? xhrOptions.unwrapSuccess : xhrOptions.unwrapError) || identity;\r\n\t\t\t\tvar response = unwrap(deserialize(extract(e.target, xhrOptions)));\r\n\t\t\t\tif (e.type === \"load\") {\r\n\t\t\t\t\tif (type.call(response) === ARRAY && xhrOptions.type) {\r\n\t\t\t\t\t\tfor (var i = 0; i < response.length; i++) response[i] = new xhrOptions.type(response[i])\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (xhrOptions.type) response = new xhrOptions.type(response)\r\n\t\t\t\t}\r\n\t\t\t\tdeferred[e.type === \"load\" ? \"resolve\" : \"reject\"](response)\r\n\t\t\t}\r\n\t\t\tcatch (e) {\r\n\t\t\t\tm.deferred.onerror(e);\r\n\t\t\t\tdeferred.reject(e)\r\n\t\t\t}\r\n\t\t\tif (xhrOptions.background !== true) m.endComputation()\r\n\t\t};\r\n\t\tajax(xhrOptions);\r\n\t\tdeferred.promise(xhrOptions.initialValue);\r\n\t\treturn deferred.promise\r\n\t};\r\n\r\n\t//testing API\r\n\tm.deps = function(mock) {\r\n\t\tinitialize(window = mock || window);\r\n\t\treturn window;\r\n\t};\r\n\t//for internal testing only, do not use `m.deps.factory`\r\n\tm.deps.factory = app;\r\n\r\n\treturn m\r\n})(typeof window != \"undefined\" ? window : {});\r\n\r\nif (typeof module != \"undefined\" && module !== null && module.exports) module.exports = m;\r\nelse if (typeof define === \"function\" && define.amd) define(function() {return m});\r\n","//\tMithril sugar tags.\n//\tCopyright (C) 2015 jsguy (Mikkel Bergmann)\n//\tMIT licensed\n(function(){\nvar mithrilSugartags = function(m, scope){\n\tm.sugarTags = m.sugarTags || {};\n\tscope = scope || m;\n\n\tvar arg = function(l1, l2){\n\t\t\tvar i;\n\t\t\tfor (i in l2) {if(l2.hasOwnProperty(i)) {\n\t\t\t\tl1.push(l2[i]);\n\t\t\t}}\n\t\t\treturn l1;\n\t\t}, \n\t\tgetClassList = function(args){\n\t\t\tvar i, result;\n\t\t\tfor(i in args) {\n\t\t\t\tif(args[i] && args[i].class) {\n\t\t\t\t\treturn typeof (args[i].class == \"string\")? \n\t\t\t\t\t\targs[i].class.split(\" \"):\n\t\t\t\t\t\tfalse;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tmakeSugarTag = function(tag) {\n\t\t\tvar c, el;\n\t\t\treturn function() {\n\t\t\t\tvar args = Array.prototype.slice.call(arguments);\n\t\t\t\t//\tif class is string, allow use of cache\n\t\t\t\tif(c = getClassList(args)) {\n\t\t\t\t\tel = [tag + \".\" + c.join(\".\")];\n\t\t\t\t\t//\tRemove class tag, so we don't duplicate\n\t\t\t\t\tfor(var i in args) {\n\t\t\t\t\t\tif(args[i] && args[i].class) {\n\t\t\t\t\t\t\tdelete args[i].class;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tel = [tag];\n\t\t\t\t}\n\t\t\t\treturn (m.e? m.e: m).apply(this, arg(el, args));\n\t\t\t};\n\t\t},\n\t\ttagList = [\"A\",\"ABBR\",\"ACRONYM\",\"ADDRESS\",\"AREA\",\"ARTICLE\",\"ASIDE\",\"AUDIO\",\"B\",\"BDI\",\"BDO\",\"BIG\",\"BLOCKQUOTE\",\"BODY\",\"BR\",\"BUTTON\",\"CANVAS\",\"CAPTION\",\"CITE\",\"CODE\",\"COL\",\"COLGROUP\",\"COMMAND\",\"DATALIST\",\"DD\",\"DEL\",\"DETAILS\",\"DFN\",\"DIV\",\"DL\",\"DT\",\"EM\",\"EMBED\",\"FIELDSET\",\"FIGCAPTION\",\"FIGURE\",\"FOOTER\",\"FORM\",\"FRAME\",\"FRAMESET\",\"H1\",\"H2\",\"H3\",\"H4\",\"H5\",\"H6\",\"HEAD\",\"HEADER\",\"HGROUP\",\"HR\",\"HTML\",\"I\",\"IFRAME\",\"IMG\",\"INPUT\",\"INS\",\"KBD\",\"KEYGEN\",\"LABEL\",\"LEGEND\",\"LI\",\"LINK\",\"MAP\",\"MARK\",\"META\",\"METER\",\"NAV\",\"NOSCRIPT\",\"OBJECT\",\"OL\",\"OPTGROUP\",\"OPTION\",\"OUTPUT\",\"P\",\"PARAM\",\"PRE\",\"PROGRESS\",\"Q\",\"RP\",\"RT\",\"RUBY\",\"SAMP\",\"SCRIPT\",\"SECTION\",\"SELECT\",\"SMALL\",\"SOURCE\",\"SPAN\",\"SPLIT\",\"STRONG\",\"STYLE\",\"SUB\",\"SUMMARY\",\"SUP\",\"TABLE\",\"TBODY\",\"TD\",\"TEXTAREA\",\"TFOOT\",\"TH\",\"THEAD\",\"TIME\",\"TITLE\",\"TR\",\"TRACK\",\"TT\",\"UL\",\"VAR\",\"VIDEO\",\"WBR\"],\n\t\tlowerTagCache = {},\n\t\ti;\n\n\t//\tCreate sugar'd functions in the required scopes\n\tfor (i in tagList) {if(tagList.hasOwnProperty(i)) {\n\t\t(function(tag){\n\t\t\tvar lowerTag = tag.toLowerCase();\n\t\t\tscope[tag] = lowerTagCache[lowerTag] = makeSugarTag(lowerTag);\n\t\t}(tagList[i]));\n\t}}\n\n\t//\tLowercased sugar tags\n\tm.sugarTags.lower = function(){\n\t\treturn lowerTagCache;\n\t};\n\n\treturn scope;\n};\n\nif (typeof module != \"undefined\" && module !== null && module.exports) {\n\tmodule.exports = mithrilSugartags;\n} else if (typeof define === \"function\" && define.amd) {\n\tdefine(function() {\n\t\treturn mithrilSugartags;\n\t});\n} else {\n\tmithrilSugartags(\n\t\ttypeof window != \"undefined\"? window.m || {}: {},\n\t\ttypeof window != \"undefined\"? window: {}\n\t);\n}\n\n}());","var validator = require('validator');\n\n/* \tThis binder allows you to create a validation method on a model, (plain \n\tjavascript function that defines some properties), that can return a set \n\tof error messages for invalid values.\n\t\n\tThe validations are from https://github.com/chriso/validator.js\t\n\n\t## Example\n\n\tSay you have an object like so:\n\n\t\tvar User = function(){\n\t\t\tthis.name = \"bob\";\n\t\t\tthis.email = \"bob_at_email.com\";\n\t\t}, user = new User();\n\n\tNow if you wanted to create an isValid function that can be used to ensure \n\tyou don't have an invalid email address, you simply add:\n\n\n\tTo your model, so you get:\n\n\t\tvar User = function(){\n\t\t\tthis.name = \"bob\";\n\t\t\tthis.email = \"bob_at_email.com\";\n\t\t\tthis.isValid = modelbinder.bind(this, {\n\t\t\t\temail: {\n\t\t\t\t\t'isEmail': \"Must be a valid email address\"\n\t\t\t\t}\n\t\t\t});\n\t\t}, user = new User();\n\n\tThen just call the `isValid` method to see if it is valid - if it is\n\tinvalid, (as it will be in this case), you will get an object like so:\n\n\t\tuser.isValid()\n\t\t//\tReturns: { email: [\"Must be a valid email address\"] }\n\n\tYou can also check if a particular field is valid like so:\n\n\t\tuser.isValid('email');\n\n */\nmodule.exports = {\n\tbind: function(self, vObj){\n\t\treturn function(name){\n\t\t\tvar result = {},\n\t\t\t\ttmp,\n\t\t\t\thasInvalidField = false,\n\t\t\t\t//\tFor some reason node-validator doesn't have this...\n\t\t\t\tisNotEmpty = function(value){\n\t\t\t\t\treturn typeof value !== \"undefined\" && value !== \"\" && value !== null;\n\t\t\t\t},\n\t\t\t\t//\tGet value of property from 'self', which can be a function.\n\t\t\t\tgetValue = function(name){\n\t\t\t\t\treturn typeof self[name] == \"function\"? self[name](): self[name];\n\t\t\t\t},\n\t\t\t\t//\tValidates a value against a set of validations\n\t\t\t\t//\tReturns true if the value is valid, or an object \n\t\t\t\tvalidate = function(name, value, validations) {\n\t\t\t\t\tvar validation,\n\t\t\t\t\t\ttmp,\n\t\t\t\t\t\tresult = [];\n\t\t\t\t\tfor(validation in validations) {\n\t\t\t\t\t\tif(validation == \"isRequired\") {\n\t\t\t\t\t\t\t//\tuse our \"isRequired\" function\n\t\t\t\t\t\t\ttmp = isNotEmpty(value)? true: validations[validation]; \n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//\tUse validator method\n\t\t\t\t\t\t\ttmp = validator[validation](value)? true: validations[validation]; \n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//\tHandle multiple messages\n\t\t\t\t\t\tif(tmp !== true) {\n\t\t\t\t\t\t\tresult = (result === true || result == \"undefined\")? []: result;\n\t\t\t\t\t\t\tresult.push(tmp);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresult = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn result;\n\t\t\t\t};\n\n\t\t\tif(name) {\n\t\t\t\tresult = validate(name, getValue(name), vObj[name]);\n\t\t\t} else {\n\t\t\t\t//\tValidate the whole model\n\t\t\t\tfor(name in vObj) {\n\t\t\t\t\ttmp = validate(name, getValue(name), vObj[name]);\n\t\t\t\t\tif(tmp !== true) {\n\t\t\t\t\t\thasInvalidField = true;\n\t\t\t\t\t}\n\t\t\t\t\tresult[name] = tmp;\n\t\t\t\t}\n\t\t\t\tif(!hasInvalidField) {\n\t\t\t\t\tresult = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn result;\n\t\t}\n\t}\n};","/*!\n * Copyright (c) 2014 Chris O'Hara <cohara87@gmail.com>\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n(function (name, definition) {\n    if (typeof exports !== 'undefined' && typeof module !== 'undefined') {\n        module.exports = definition();\n    } else if (typeof define === 'function' && typeof define.amd === 'object') {\n        define(definition);\n    } else {\n        this[name] = definition();\n    }\n})('validator', function (validator) {\n\n    'use strict';\n\n    validator = { version: '3.27.0' };\n\n    var email = /^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))$/i;\n\n    var creditCard = /^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\\d{3})\\d{11})$/;\n\n    var isbn10Maybe = /^(?:[0-9]{9}X|[0-9]{10})$/\n      , isbn13Maybe = /^(?:[0-9]{13})$/;\n\n    var ipv4Maybe = /^(\\d?\\d?\\d)\\.(\\d?\\d?\\d)\\.(\\d?\\d?\\d)\\.(\\d?\\d?\\d)$/\n      , ipv6 = /^::|^::1|^([a-fA-F0-9]{1,4}::?){1,7}([a-fA-F0-9]{1,4})$/;\n\n    var uuid = {\n        '3': /^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i\n      , '4': /^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i\n      , '5': /^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i\n      , all: /^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i\n    };\n\n    var alpha = /^[a-zA-Z]+$/\n      , alphanumeric = /^[a-zA-Z0-9]+$/\n      , numeric = /^-?[0-9]+$/\n      , int = /^(?:-?(?:0|[1-9][0-9]*))$/\n      , float = /^(?:-?(?:[0-9]+))?(?:\\.[0-9]*)?(?:[eE][\\+\\-]?(?:[0-9]+))?$/\n      , hexadecimal = /^[0-9a-fA-F]+$/\n      , hexcolor = /^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/;\n\n    var ascii = /^[\\x00-\\x7F]+$/\n      , multibyte = /[^\\x00-\\x7F]/\n      , fullWidth = /[^\\u0020-\\u007E\\uFF61-\\uFF9F\\uFFA0-\\uFFDC\\uFFE8-\\uFFEE0-9a-zA-Z]/\n      , halfWidth = /[\\u0020-\\u007E\\uFF61-\\uFF9F\\uFFA0-\\uFFDC\\uFFE8-\\uFFEE0-9a-zA-Z]/;\n\n    var surrogatePair = /[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/;\n\n    var base64 = /^(?:[A-Za-z0-9+\\/]{4})*(?:[A-Za-z0-9+\\/]{2}==|[A-Za-z0-9+\\/]{3}=|[A-Za-z0-9+\\/]{4})$/;\n\n    var phones = {\n      'zh-CN': /^(\\+?0?86\\-?)?1[345789][0-9]{9}$/,\n      'en-ZA': /^(\\+?27|0)(\\d{9})$/,\n      'en-AU': /^(\\+?61|0)4(\\d{8})/\n    };\n\n    validator.extend = function (name, fn) {\n        validator[name] = function () {\n            var args = Array.prototype.slice.call(arguments);\n            args[0] = validator.toString(args[0]);\n            return fn.apply(validator, args);\n        };\n    };\n\n    //Right before exporting the validator object, pass each of the builtins\n    //through extend() so that their first argument is coerced to a string\n    validator.init = function () {\n        for (var name in validator) {\n            if (typeof validator[name] !== 'function' || name === 'toString' ||\n                    name === 'toDate' || name === 'extend' || name === 'init') {\n                continue;\n            }\n            validator.extend(name, validator[name]);\n        }\n    };\n\n    validator.toString = function (input) {\n        if (typeof input === 'object' && input !== null && input.toString) {\n            input = input.toString();\n        } else if (input === null || typeof input === 'undefined' || (isNaN(input) && !input.length)) {\n            input = '';\n        } else if (typeof input !== 'string') {\n            input += '';\n        }\n        return input;\n    };\n\n    validator.toDate = function (date) {\n        if (Object.prototype.toString.call(date) === '[object Date]') {\n            return date;\n        }\n        date = Date.parse(date);\n        return !isNaN(date) ? new Date(date) : null;\n    };\n\n    validator.toFloat = function (str) {\n        return parseFloat(str);\n    };\n\n    validator.toInt = function (str, radix) {\n        return parseInt(str, radix || 10);\n    };\n\n    validator.toBoolean = function (str, strict) {\n        if (strict) {\n            return str === '1' || str === 'true';\n        }\n        return str !== '0' && str !== 'false' && str !== '';\n    };\n\n    validator.equals = function (str, comparison) {\n        return str === validator.toString(comparison);\n    };\n\n    validator.contains = function (str, elem) {\n        return str.indexOf(validator.toString(elem)) >= 0;\n    };\n\n    validator.matches = function (str, pattern, modifiers) {\n        if (Object.prototype.toString.call(pattern) !== '[object RegExp]') {\n            pattern = new RegExp(pattern, modifiers);\n        }\n        return pattern.test(str);\n    };\n\n    validator.isEmail = function (str) {\n        return email.test(str);\n    };\n\n    var default_url_options = {\n        protocols: [ 'http', 'https', 'ftp' ]\n      , require_tld: true\n      , require_protocol: false\n      , allow_underscores: false\n      , allow_trailing_dot: false\n    };\n\n    validator.isURL = function (url, options) {\n        if (!url || url.length >= 2083) {\n            return false;\n        }\n        if (url.indexOf('mailto:') === 0) {\n            return false;\n        }\n        options = merge(options, default_url_options);\n        var protocol, user, pass, auth, host, hostname, port,\n            port_str, path, query, hash, split;\n        split = url.split('://');\n        if (split.length > 1) {\n            protocol = split.shift();\n            if (options.protocols.indexOf(protocol) === -1) {\n                return false;\n            }\n        } else if (options.require_protocol) {\n            return false;\n        }\n        url = split.join('://');\n        split = url.split('#');\n        url = split.shift();\n        hash = split.join('#');\n        if (hash && /\\s/.test(hash)) {\n            return false;\n        }\n        split = url.split('?');\n        url = split.shift();\n        query = split.join('?');\n        if (query && /\\s/.test(query)) {\n            return false;\n        }\n        split = url.split('/');\n        url = split.shift();\n        path = split.join('/');\n        if (path && /\\s/.test(path)) {\n            return false;\n        }\n        split = url.split('@');\n        if (split.length > 1) {\n            auth = split.shift();\n            if (auth.indexOf(':') >= 0) {\n                auth = auth.split(':');\n                user = auth.shift();\n                if (!/^\\S+$/.test(user)) {\n                    return false;\n                }\n                pass = auth.join(':');\n                if (!/^\\S*$/.test(user)) {\n                    return false;\n                }\n            }\n        }\n        hostname = split.join('@');\n        split = hostname.split(':');\n        host = split.shift();\n        if (split.length) {\n            port_str = split.join(':');\n            port = parseInt(port_str, 10);\n            if (!/^[0-9]+$/.test(port_str) || port <= 0 || port > 65535) {\n                return false;\n            }\n        }\n        if (!validator.isIP(host) && !validator.isFQDN(host, options) &&\n                host !== 'localhost') {\n            return false;\n        }\n        if (options.host_whitelist &&\n                options.host_whitelist.indexOf(host) === -1) {\n            return false;\n        }\n        if (options.host_blacklist &&\n                options.host_blacklist.indexOf(host) !== -1) {\n            return false;\n        }\n        return true;\n    };\n\n    validator.isIP = function (str, version) {\n        version = validator.toString(version);\n        if (!version) {\n            return validator.isIP(str, 4) || validator.isIP(str, 6);\n        } else if (version === '4') {\n            if (!ipv4Maybe.test(str)) {\n                return false;\n            }\n            var parts = str.split('.').sort(function (a, b) {\n                return a - b;\n            });\n            return parts[3] <= 255;\n        }\n        return version === '6' && ipv6.test(str);\n    };\n\n    var default_fqdn_options = {\n        require_tld: true\n      , allow_underscores: false\n      , allow_trailing_dot: false\n    };\n\n    validator.isFQDN = function (str, options) {\n        options = merge(options, default_fqdn_options);\n\n        /* Remove the optional trailing dot before checking validity */\n        if (options.allow_trailing_dot && str[str.length - 1] === '.') {\n            str = str.substring(0, str.length - 1);\n        }\n        var parts = str.split('.');\n        if (options.require_tld) {\n            var tld = parts.pop();\n            if (!parts.length || !/^[a-z]{2,}$/i.test(tld)) {\n                return false;\n            }\n        }\n        for (var part, i = 0; i < parts.length; i++) {\n            part = parts[i];\n            if (options.allow_underscores) {\n                if (part.indexOf('__') >= 0) {\n                    return false;\n                }\n                part = part.replace(/_/g, '');\n            }\n            if (!/^[a-z\\u00a1-\\uffff0-9-]+$/i.test(part)) {\n                return false;\n            }\n            if (part[0] === '-' || part[part.length - 1] === '-' ||\n                    part.indexOf('---') >= 0) {\n                return false;\n            }\n        }\n        return true;\n    };\n\n    validator.isAlpha = function (str) {\n        return alpha.test(str);\n    };\n\n    validator.isAlphanumeric = function (str) {\n        return alphanumeric.test(str);\n    };\n\n    validator.isNumeric = function (str) {\n        return numeric.test(str);\n    };\n\n    validator.isHexadecimal = function (str) {\n        return hexadecimal.test(str);\n    };\n\n    validator.isHexColor = function (str) {\n        return hexcolor.test(str);\n    };\n\n    validator.isLowercase = function (str) {\n        return str === str.toLowerCase();\n    };\n\n    validator.isUppercase = function (str) {\n        return str === str.toUpperCase();\n    };\n\n    validator.isInt = function (str) {\n        return int.test(str);\n    };\n\n    validator.isFloat = function (str) {\n        return str !== '' && float.test(str);\n    };\n\n    validator.isDivisibleBy = function (str, num) {\n        return validator.toFloat(str) % validator.toInt(num) === 0;\n    };\n\n    validator.isNull = function (str) {\n        return str.length === 0;\n    };\n\n    validator.isLength = function (str, min, max) {\n        var surrogatePairs = str.match(/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/g) || [];\n        var len = str.length - surrogatePairs.length;\n        return len >= min && (typeof max === 'undefined' || len <= max);\n    };\n\n    validator.isByteLength = function (str, min, max) {\n        return str.length >= min && (typeof max === 'undefined' || str.length <= max);\n    };\n\n    validator.isUUID = function (str, version) {\n        var pattern = uuid[version ? version : 'all'];\n        return pattern && pattern.test(str);\n    };\n\n    validator.isDate = function (str) {\n        return !isNaN(Date.parse(str));\n    };\n\n    validator.isAfter = function (str, date) {\n        var comparison = validator.toDate(date || new Date())\n          , original = validator.toDate(str);\n        return !!(original && comparison && original > comparison);\n    };\n\n    validator.isBefore = function (str, date) {\n        var comparison = validator.toDate(date || new Date())\n          , original = validator.toDate(str);\n        return original && comparison && original < comparison;\n    };\n\n    validator.isIn = function (str, options) {\n        var i;\n        if (Object.prototype.toString.call(options) === '[object Array]') {\n            var array = [];\n            for (i in options) {\n                array[i] = validator.toString(options[i]);\n            }\n            return array.indexOf(str) >= 0;\n        } else if (typeof options === 'object') {\n            return options.hasOwnProperty(str);\n        } else if (options && typeof options.indexOf === 'function') {\n            return options.indexOf(str) >= 0;\n        }\n        return false;\n    };\n\n    validator.isCreditCard = function (str) {\n        var sanitized = str.replace(/[^0-9]+/g, '');\n        if (!creditCard.test(sanitized)) {\n            return false;\n        }\n        var sum = 0, digit, tmpNum, shouldDouble;\n        for (var i = sanitized.length - 1; i >= 0; i--) {\n            digit = sanitized.substring(i, (i + 1));\n            tmpNum = parseInt(digit, 10);\n            if (shouldDouble) {\n                tmpNum *= 2;\n                if (tmpNum >= 10) {\n                    sum += ((tmpNum % 10) + 1);\n                } else {\n                    sum += tmpNum;\n                }\n            } else {\n                sum += tmpNum;\n            }\n            shouldDouble = !shouldDouble;\n        }\n        return !!((sum % 10) === 0 ? sanitized : false);\n    };\n\n    validator.isISBN = function (str, version) {\n        version = validator.toString(version);\n        if (!version) {\n            return validator.isISBN(str, 10) || validator.isISBN(str, 13);\n        }\n        var sanitized = str.replace(/[\\s-]+/g, '')\n          , checksum = 0, i;\n        if (version === '10') {\n            if (!isbn10Maybe.test(sanitized)) {\n                return false;\n            }\n            for (i = 0; i < 9; i++) {\n                checksum += (i + 1) * sanitized.charAt(i);\n            }\n            if (sanitized.charAt(9) === 'X') {\n                checksum += 10 * 10;\n            } else {\n                checksum += 10 * sanitized.charAt(9);\n            }\n            if ((checksum % 11) === 0) {\n                return !!sanitized;\n            }\n        } else  if (version === '13') {\n            if (!isbn13Maybe.test(sanitized)) {\n                return false;\n            }\n            var factor = [ 1, 3 ];\n            for (i = 0; i < 12; i++) {\n                checksum += factor[i % 2] * sanitized.charAt(i);\n            }\n            if (sanitized.charAt(12) - ((10 - (checksum % 10)) % 10) === 0) {\n                return !!sanitized;\n            }\n        }\n        return false;\n    };\n\n    validator.isMobilePhone = function(str, locale) {\n        if (locale in phones) {\n            return phones[locale].test(str);\n        }\n        return false;\n    };\n\n    validator.isJSON = function (str) {\n        try {\n            JSON.parse(str);\n        } catch (e) {\n            return false;\n        }\n        return true;\n    };\n\n    validator.isMultibyte = function (str) {\n        return multibyte.test(str);\n    };\n\n    validator.isAscii = function (str) {\n        return ascii.test(str);\n    };\n\n    validator.isFullWidth = function (str) {\n        return fullWidth.test(str);\n    };\n\n    validator.isHalfWidth = function (str) {\n        return halfWidth.test(str);\n    };\n\n    validator.isVariableWidth = function (str) {\n        return fullWidth.test(str) && halfWidth.test(str);\n    };\n\n    validator.isSurrogatePair = function (str) {\n        return surrogatePair.test(str);\n    };\n\n    validator.isBase64 = function (str) {\n        return base64.test(str);\n    };\n\n    validator.isMongoId = function (str) {\n        return validator.isHexadecimal(str) && str.length === 24;\n    };\n\n    validator.ltrim = function (str, chars) {\n        var pattern = chars ? new RegExp('^[' + chars + ']+', 'g') : /^\\s+/g;\n        return str.replace(pattern, '');\n    };\n\n    validator.rtrim = function (str, chars) {\n        var pattern = chars ? new RegExp('[' + chars + ']+$', 'g') : /\\s+$/g;\n        return str.replace(pattern, '');\n    };\n\n    validator.trim = function (str, chars) {\n        var pattern = chars ? new RegExp('^[' + chars + ']+|[' + chars + ']+$', 'g') : /^\\s+|\\s+$/g;\n        return str.replace(pattern, '');\n    };\n\n    validator.escape = function (str) {\n        return (str.replace(/&/g, '&amp;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#x27;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\\//g, '&#x2F;'));\n    };\n\n    validator.stripLow = function (str, keep_new_lines) {\n        var chars = keep_new_lines ? '\\x00-\\x09\\x0B\\x0C\\x0E-\\x1F\\x7F' : '\\x00-\\x1F\\x7F';\n        return validator.blacklist(str, chars);\n    };\n\n    validator.whitelist = function (str, chars) {\n        return str.replace(new RegExp('[^' + chars + ']+', 'g'), '');\n    };\n\n    validator.blacklist = function (str, chars) {\n        return str.replace(new RegExp('[' + chars + ']+', 'g'), '');\n    };\n\n    var default_normalize_email_options = {\n        lowercase: true\n    };\n\n    validator.normalizeEmail = function (email, options) {\n        options = merge(options, default_normalize_email_options);\n        if (!validator.isEmail(email)) {\n            return false;\n        }\n        var parts = email.split('@', 2);\n        parts[1] = parts[1].toLowerCase();\n        if (options.lowercase) {\n            parts[0] = parts[0].toLowerCase();\n        }\n        if (parts[1] === 'gmail.com' || parts[1] === 'googlemail.com') {\n            if (!options.lowercase) {\n                parts[0] = parts[0].toLowerCase();\n            }\n            parts[0] = parts[0].replace(/\\./g, '').split('+')[0];\n            parts[1] = 'gmail.com';\n        }\n        return parts.join('@');\n    };\n\n    function merge(obj, defaults) {\n        obj = obj || {};\n        for (var key in defaults) {\n            if (typeof obj[key] === 'undefined') {\n                obj[key] = defaults[key];\n            }\n        }\n        return obj;\n    }\n\n    validator.init();\n\n    return validator;\n\n});\n"]}